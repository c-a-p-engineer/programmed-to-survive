import"./modulepreload-polyfill-B5Qt9EMX.js";const be={frames:[{id:"light",name:"LIGHT",hp:70,speed:240,en:100,enRegen:18,desc:"高速。薄い。回避で生きる。"},{id:"middle",name:"MIDDLE",hp:95,speed:210,en:120,enRegen:14,desc:"標準。バランス。"},{id:"heavy",name:"HEAVY",hp:130,speed:175,en:140,enRegen:11,desc:"鈍い。硬い。詰みづらい。"}],weapons:[{id:"mg",name:"Machinegun",type:"bullet",range:900,dps:14,cd:.1,speed:1e3,desc:"連射。見てて気持ちいい。",pierce:!1,explodeOnObstacle:!1},{id:"cannon",name:"Cannon",type:"bullet",range:1250,dps:22,cd:.55,speed:1250,desc:"高威力。遠距離。",pierce:!1,explodeOnObstacle:!1},{id:"missile",name:"Missile",type:"missile",range:1050,dps:18,cd:.7,speed:800,radius:110,desc:"範囲。雑に強い。",pierce:!1,explodeOnObstacle:!0},{id:"grenade",name:"Grenade",type:"lob",range:520,dps:16,cd:.85,speed:620,radius:85,desc:"近〜中。範囲。",pierce:!1,explodeOnObstacle:!0},{id:"blade",name:"Blade",type:"melee",range:120,dps:22,cd:.45,speed:0,desc:"近接。扇型。"},{id:"mine",name:"Mine",type:"mine",range:0,dps:22,cd:1.1,speed:0,radius:120,armMs:240,desc:"設置。踏ませる。"}],ai:[{id:"balanced",name:"Balanced",keep:.75,fleeHp:.18,prefer:"mid",desc:"無難。死ににくい。"},{id:"sniper",name:"Sniper",keep:.95,fleeHp:.12,prefer:"far",desc:"距離を取る。"},{id:"berserker",name:"Berserker",keep:.35,fleeHp:.08,prefer:"near",desc:"突っ込む。死にやすい。"},{id:"coward",name:"Coward",keep:.98,fleeHp:.35,prefer:"far",desc:"逃げる。稼げない。"},{id:"hunter",name:"Hunter",keep:.65,fleeHp:.1,prefer:"mid",desc:"近い敵を確実に。"}]},Ze=Object.fromEntries(be.weapons.map(f=>[f.id,f])),da=Object.fromEntries(be.frames.map(f=>[f.id,f])),pa=Object.fromEntries(be.ai.map(f=>[f.id,f])),ha=(f,B)=>{let S=null;const x=B.debug,X=B.toast,H=B.mechLog;function E(t,p,n){return t<p?p:t>n?n:t}function le(t,p,n,h){var r=h===1?10:h===2?18:6,u=h===2?16732120:16777215,G=t.add.circle(p,n,r,u,h===2?.18:.22);G.setBlendMode(Phaser.BlendModes.ADD),G.setDepth(5),t.tweens.add({targets:G,alpha:0,duration:160,onComplete:function(){G.active&&G.destroy()}})}function ee(t,p,n){var h=t.cameras.main,r=h.width,u=h.height,G=Math.min(r,u),k=Math.max(6,Math.round(G*.02)),D=Math.max(2,Math.round(G*.008)),$=D,I=Math.max(96,Math.round(u*.15)),a=u-I-D;t.topPanelG&&t.topPanelG.clear();var v=Math.floor((n||0)*1e3),e=Math.floor(n||0),R=String(Math.floor(e/60)).padStart(2,"0"),d=String(e%60).padStart(2,"0");if(t.waveTimeText&&(t.waveTimeText.setText("W"+String(p.wave||1)+"  "+R+":"+d),t.waveTimeText.setPosition(D+k,$+k),t.waveTimeText.setVisible(!0),t.waveTimeText.setAlpha(1)),t.bottomPanelG&&t.bottomPanelG.clear(),t.mechInfoText){var s=p.cfg.frame?p.cfg.frame.name:"-",c=p.cfg.ai?p.cfg.ai.name:"-";t.mechInfoText.setText("FRAME "+s+"   AI "+c),t.mechInfoText.setWordWrapWidth(Math.round(r*.55),!0),t.mechInfoText.setPosition(D+k,a+I-D-8),t.mechInfoText.setVisible(!0),t.mechInfoText.setAlpha(.9)}if(t.hpGroup){var i=Math.max(0,p.hp|0),l=Math.max(1,p.hpMax??p.maxHp??1),o=Math.max(0,(p.exp??p.score??0)|0);if(t.hpText.setText("HP "+i+"/"+l),t.expText.setText("EXP "+o),t.hpText.setPosition(0,0),t.expText.setPosition(0,30),t.hpGroup.setPosition(D+k,a+k),t.hpGroup.setVisible(!0),t.hpGroup.setAlpha(1),t.hpBarG&&t.expBarG){var M=Math.max(128,Math.round(r*.32));t.hpBarG.clear(),t.hpBarG.fillStyle(16777215,.12),t.hpBarG.fillRoundedRect(0,22,M,12,6),t.hpBarG.fillStyle(65484,.8),t.hpBarG.fillRoundedRect(0,22,Math.max(6,M*E(i/l,0,1)),12,6),t.expBarG.clear(),t.expBarG.fillStyle(16777215,.08),t.expBarG.fillRoundedRect(0,52,M,8,5),t.expBarG.fillStyle(16765803,.55),t.expBarG.fillRoundedRect(0,52,Math.max(6,M*E(o%100/100,0,1)),8,5)}}if(t.weaponGroup){var N=p.cfg.wpnA?p.cfg.wpnA.name:"A",w=p.cfg.wpnB?p.cfg.wpnB.name:"B",Y=function(U){return U.length>16?U.slice(0,15)+"…":U},K=Math.max(140,Math.round(r*.28));t.weaponMainText.setText("MAIN "+Y(N)),t.weaponSubText.setText("SUB "+Y(w)),t.weaponMainText.setPosition(24,0),t.weaponSubText.setPosition(24,22),t.weaponGroup.setPosition(r-D-k-K,a+k),t.weaponGroup.setVisible(!0),t.weaponGroup.setAlpha(1),t.weaponG&&(t.weaponG.clear(),t.weaponG.fillStyle(65484,.9),t.weaponG.fillRoundedRect(0,2,16,16,4),t.weaponG.fillStyle(6728447,.9),t.weaponG.fillRoundedRect(0,24,16,16,4))}if(t.scorePanelG&&t.scoreLabelText&&t.scoreValueText){t.scoreLabelText.setText("SCORE"),t.scoreValueText.setText(String(p.score|0));var y=8,m=Math.max(t.scoreLabelText.width,t.scoreValueText.width)+y*2,C=t.scoreLabelText.height+t.scoreValueText.height+8,b=r-m-D,A=$+D;t.scorePanelG.clear(),t.scorePanelG.fillStyle(0,.45),t.scorePanelG.fillRoundedRect(b,A,m,C,12),t.scorePanelG.lineStyle(2,65484,.16),t.scorePanelG.strokeRoundedRect(b,A,m,C,12),t.scoreLabelText.setPosition(b+y,A+4),t.scoreValueText.setPosition(b+y,A+4+t.scoreLabelText.height),t.scoreLabelText.setVisible(!0),t.scoreValueText.setVisible(!0),t.scoreLabelText.setAlpha(1),t.scoreValueText.setAlpha(1)}if(t.radarG){var O=Math.round(Math.min(48,Math.max(36,r*.13))),q=Math.round(Math.min(240,Math.max(170,r*.3)));t.radarR=O,t.radarX=r-q-O-D-k,t.radarY=a-O-k-8}t.prevScore!==(p.score|0)&&(t.prevScore=p.score|0,t.scoreValueText&&t.tweens.add({targets:t.scoreValueText,scale:1.12,duration:120,yoyo:!0,ease:"Quad.out"})),t.prevHp!=null&&(p.hp|0)<(t.prevHp|0)&&t.hpGroup&&t.tweens.add({targets:t.hpGroup,alpha:.4,duration:120,yoyo:!0,repeat:1}),t.prevHp=p.hp|0,p.battleTimeMs=v}function j(t,p,n,h,r){if(!t.obstacles)return!1;var u=new Phaser.Geom.Line(p,n,h,r),G=t.obstacles.getChildren(),k=h-p,D=r-n,$=Math.sqrt(k*k+D*D);if($<1)return!1;for(var I=0;I<G.length;I++){var a=G[I];if(a.active){var v=a.body;if(v){var e=v.x+v.width*.5,R=v.y+v.height*.5,d=e-p,s=R-n,c=Math.sqrt(d*d+s*s);if(!(c<34)&&!(c>$-10)){var i=new Phaser.Geom.Rectangle(v.x,v.y,v.width,v.height);if(Phaser.Geom.Intersects.LineToRectangle(u,i))return!0}}}}return!1}function ae(t,p,n,h,r){if(!t.obstacles)return null;for(var u=new Phaser.Geom.Line(p,n,h,r),G=t.obstacles.getChildren(),k=null,D=1e9,$=0;$<G.length;$++){var I=G[$];if(!(!I.active||!I.body)){var a=I.body,v=new Phaser.Geom.Rectangle(a.x,a.y,a.width,a.height);if(Phaser.Geom.Intersects.LineToRectangle(u,v)){var e=a.x+a.width*.5,R=a.y+a.height*.5,d=Phaser.Math.Distance.Between(p,n,e,R);d<D&&(D=d,k=I)}}}return k}function Q(t,p,n,h){var r=t.make.graphics({x:0,y:0,add:!1});r.clear(),r.fillStyle(h,1),r.fillTriangle(n/2,1,1,n-1,n-1,n-1),r.generateTexture(p,n,n),r.destroy()}function ge(t,p,n,h){var r=t.make.graphics({x:0,y:0,add:!1});r.clear(),r.fillStyle(0,.35),r.fillCircle(n/2+1,n/2+1,n/2),r.fillStyle(h,1),r.fillCircle(n/2,n/2,n/2-1),r.generateTexture(p,n,n),r.destroy()}function fe(t,p,n,h,r){var u=t.make.graphics({x:0,y:0,add:!1});u.clear(),u.fillStyle(r,1),u.fillRoundedRect(0,0,n,h,10),u.lineStyle(2,16777215,.12),u.strokeRoundedRect(2,2,n-4,h-4,8),u.lineStyle(1,65484,.1),u.beginPath(),u.moveTo(8,h*.35),u.lineTo(n-8,h*.35),u.moveTo(8,h*.65),u.lineTo(n-8,h*.65),u.strokePath(),u.generateTexture(p,n,h),u.destroy()}function Ge(t,p,n){var h=t.make.graphics({x:0,y:0,add:!1});h.clear(),h.fillStyle(724758,1),h.fillCircle(n/2,n/2,n/2),h.lineStyle(2,65484,.55),h.strokeCircle(n/2,n/2,n/2-2),h.fillStyle(65484,.18),h.fillCircle(n/2,n/2,n/2-4),h.generateTexture(p,n,n),h.destroy()}function De(t){if(S){try{S.destroy(!0)}catch{}S=null}var p=430,n=820,h={type:Phaser.AUTO,parent:"game",width:p,height:n,backgroundColor:"#05070b",physics:{default:"arcade",arcade:{debug:!1,gravity:{y:0}}},scene:{preload:G,create:k,update:I}};const r={cfg:t,hp:t.frame.hp,hpMax:t.frame.hp,en:t.frame.en,enMax:t.frame.en,enRegen:t.frame.enRegen,speed:t.frame.speed,score:0,t0:0,lastA:0,lastB:0,target:null,lastSwitch:0,targetDist:0,lastDelta:0,dead:!1};var u=["obA","obB","obC"];function G(){Q(this,"p",30,65484),Q(this,"e",26,16731469),ge(this,"ba",10,65484),ge(this,"bb",10,16732120),Ge(this,"mn",22),fe(this,"obA",140,90,2765892),fe(this,"obB",220,130,2305082),fe(this,"obC",110,180,2568772)}function k(){x("scene.create");var a=this;a.rangeTexts||(a.rangeTexts=[]),a.lockG||(a.lockG=a.add.graphics().setDepth(4)),a.radarG||(a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900),r.t0=a.time.now,r.startMs=a.time.now,a.physics.world.setBounds(-4e3,-4e3,8e3,8e3),a.player=a.physics.add.image(0,0,"p"),a.player.setDepth(2),a.player.setCircle(10),a.enemies=a.physics.add.group(),a.spawnAcc=0,a.spawnInterval=.85;function v(){var y=Math.random()*Math.PI*2,m=520+Math.random()*520,C=a.player.x+Math.cos(y)*m,b=a.player.y+Math.sin(y)*m,A=a.enemies.create(C,b,"e");return A.setData("hp",18),A.setData("blocked",!1),A.setRotation(Phaser.Math.Angle.Between(C,b,a.player.x,a.player.y)+Math.PI/2),A.setCollideWorldBounds(!1),A.setDepth(1),A}for(var e=0;e<6;e++)v();x("spawn init enemies="+a.enemies.getChildren().length),a.obsSpawnAcc=0,a.obsSpawnInterval=2.4,a.bullets=a.physics.add.group(),a.mines=a.physics.add.group(),a.obstacles=a.physics.add.staticGroup();for(var R=0;R<25;R++){var d=Math.random()*Math.PI*2,s=280+Math.random()*1400,c=a.player.x+Math.cos(d)*s,i=a.player.y+Math.sin(d)*s,l=u[Math.random()*u.length|0],o=a.obstacles.create(c,i,l),M=o.body&&o.body.width?o.body.width:o.displayWidth||60,N=o.body&&o.body.height?o.body.height:o.displayHeight||60,w=Math.max(30,Math.floor(M*N/10));o.setData("maxHp",w),o.setData("hp",w),o.setAlpha(.55),o.setAlpha(.85),o.setRotation((Math.random()*2-1)*.18),o.setDepth(0),o.refreshBody()}a.obAcc=0,a.mechInfoText=a.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"16px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:5}).setScrollFactor(0).setDepth(12).setOrigin(0,1),a.barG=a.add.graphics().setScrollFactor(0).setDepth(10),a.rangeG=a.add.graphics().setDepth(0),a.lockG=a.add.graphics().setDepth(4),a.rangeTexts=[],a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900,a.cameras.main.startFollow(a.player,!0,.12,.12);var Y=Math.max(r.cfg.wpnA.range||0,r.cfg.wpnB.range||0,520),K=E(680/Y,.45,.9);a.cameras.main.setZoom(K),a.physics.add.overlap(a.bullets,a.enemies,function(y,m){if(!(!y.active||!m.active)){le(a,y.x,y.y,y.getData("pierce")?1:0);var C=y.getData("dmg")||6,b=m.getData("hp")||20;b-=C,m.setData("hp",b),y.destroy(),b<=0&&(m.destroy(),r.score+=1,r.kills=(r.kills||0)+1,H("kill",r.battleTimeMs||0,"KILL ("+(y.getData("weaponName")||"WEAPON")+")"))}}),a.physics.add.overlap(a.bullets,a.obstacles,function(y,m){if(!(!y.active||!m.active)){var C=y.getData("bornAt")||0;if(!(C&&a.time.now-C<60)){var b=y.getData("aoe")||0,A=y.getData("dmg")||10;if(b>0&&y.getData("explodeOnObstacle")){le(a,y.x,y.y,2);var O=a.add.circle(y.x,y.y,b,16732120,.14);O.setBlendMode(Phaser.BlendModes.ADD),a.time.delayedCall(180,function(){O.active&&O.destroy()})}else le(a,y.x,y.y,1);var q=m.getData("hp"),U=m.getData("maxHp")||60;typeof q!="number"&&(q=U),q-=A,m.setData("hp",q);var J=Math.max(0,q/U);if(m.setAlpha(.25+J*.45),m.setTint){var L=J<.5?9082293:7306918;J<.25&&(L=9132634),m.setTint(L)}q<=0&&(le(a,m.x,m.y,2),m.destroy(),H("obj",r.battleTimeMs||0,"OBJECT DESTROYED")),y.destroy()}}}),a.physics.add.collider(a.player,a.obstacles),a.physics.add.collider(a.enemies,a.obstacles),a.input.on("pointerdown",function(y){if(!r.dead){var m=Phaser.Math.Angle.Between(a.player.x,a.player.y,y.worldX,y.worldY);a.player.rotation=m+Math.PI/2,a.physics.velocityFromRotation(m,r.speed,a.player.body.velocity)}}),a.spawnAcc=0,a.dmgAcc=0,X("BATTLE STARTED"),x("Battle started")}function D(a){for(var v=a.enemies.getChildren(),e=0;e<2;e++){for(var R=null,d=1e18,s=0;s<v.length;s++){var c=v[s];if(c.active){var i=j(a,a.player.x,a.player.y,c.x,c.y);if(!(e===0&&i)){var l=c.x-a.player.x,o=c.y-a.player.y,M=l*l+o*o;M<d&&(d=M,R=c)}}}if(R)return R}return null}function $(a,v,e,R){if(!r.dead&&!(!r.target||!r.target.active)){var d=v,s=r.target,c=a.player.x,i=a.player.y,l=s.x,o=s.y,M=Phaser.Math.Distance.Between(c,i,l,o);if(!(d.range>0&&M>d.range)){if(d.type!=="melee"&&d.type!=="mine"){var N=j(a,c,i,l,o);if(N){var w=ae(a,c,i,l,o);if(w&&w.active)l=w.x,o=w.y,w.body&&(l=w.body.x+w.body.width*.5,o=w.body.y+w.body.height*.5),a._breakCoverAcc=(a._breakCoverAcc||0)+(r.lastDelta||0),a._breakCoverAcc>1200&&(a._breakCoverAcc=0,H("obj",r.battleTimeMs||0,"BREAK COVER → obstacle"));else return}}if(d.type==="melee"){var Y=Math.PI*.65,K=Phaser.Math.Angle.Between(c,i,l,o);a.player.rotation=K+Math.PI/2,a.slashG||(a.slashG=a.add.graphics(),a.slashG.setDepth(2)),a.slashG.clear(),a.slashG.fillStyle(65484,.1),a.slashG.lineStyle(2,65484,.28),a.slashG.beginPath(),a.slashG.slice(c,i,d.range,K-Y/2,K+Y/2,!1),a.slashG.closePath(),a.slashG.fillPath(),a.slashG.strokePath(),a.time.delayedCall(90,function(){a.slashG&&a.slashG.clear()});for(var y=a.enemies.getChildren(),m=Math.max(10,Math.floor(d.dps*d.cd)),C=0;C<y.length;C++){var b=y[C];if(b.active){var A=b.x-c,O=b.y-i,q=Math.sqrt(A*A+O*O);if(!(q>d.range)){var U=Math.atan2(O,A),J=Phaser.Math.Angle.Wrap(U-K);Math.abs(J)<=Y/2&&(b.setData("hp",(b.getData("hp")||20)-m),b.getData("hp")<=0&&(b.destroy(),r.score+=1))}}}return}if(d.type==="mine"){var L=a.physics.add.image(c,i,"mn");L.setDepth(1),L.setCircle(10),L.body.setImmovable(!0),L.body.setVelocity(0,0),L.setAlpha(.55),L.setData("armed",!1),L.setData("armAt",e+(d.armMs||240)),L.setData("radius",d.radius||120),L.setData("dmg",Math.max(12,Math.floor(d.dps*.9))),a.mines.add(L);return}var Z=Phaser.Math.Angle.Between(c,i,l,o);a.player.rotation=Z+Math.PI/2;var ve=Math.cos(Z)*26,ke=Math.sin(Z)*26,T=a.physics.add.image(c+ve,i+ke,R);T.setDepth(3),T.setCircle(4),T.setData("dmg",Math.max(6,Math.floor(d.dps*d.cd))),T.setData("bornAt",e),T.setData("pierce",!!d.pierce),T.setData("explodeOnObstacle",!!d.explodeOnObstacle),a.bullets.add(T),a.physics.velocityFromRotation(Z,d.speed||1e3,T.body.velocity);var Ae=Math.floor((d.range||900)/(d.speed||1e3)*1e3)+1200;a.time.delayedCall(Ae,function(){T.active&&T.destroy()}),(d.type==="lob"||d.type==="missile")&&(T.setData("aoe",d.radius||90),T.setData("explodeOnObstacle",!!d.explodeOnObstacle))}}}function I(a,v){var e=this,R=r.startMs!=null?(e.time.now-r.startMs)/1e3:0;r.lastDelta=v;try{if(e._dbgAcc=(e._dbgAcc||0)+v,e._dbgAcc>700&&(e._dbgAcc=0,x("tick "+Math.floor(a))),r.dead)return;if(r.en=E(r.en+r.enRegen*(v/1e3),0,r.enMax),e.spawnAcc+=v/1e3,e.spawnAcc>=e.spawnInterval&&(e.spawnAcc=0,e.enemies.getChildren().length<26)){var d=Math.random()*Math.PI*2,s=560+Math.random()*660,c=e.player.x+Math.cos(d)*s,i=e.player.y+Math.sin(d)*s,l=e.enemies.create(c,i,"e");l.setData("hp",18),l.setData("blocked",!1),l.setRotation(Phaser.Math.Angle.Between(c,i,e.player.x,e.player.y)+Math.PI/2),l.setDepth(1)}e._cntAcc=(e._cntAcc||0)+v,e._cntAcc>2500&&(e._cntAcc=0,x("counts enemies="+e.enemies.getChildren().length+" obstacles="+(e.obstacles?e.obstacles.getChildren().length:0)+" bullets="+e.bullets.getChildren().length));for(var V=e.enemies&&e.enemies.getChildren?e.enemies.getChildren():[],o=0;o<V.length;o++){var l=V[o];if(!(!l.active||!l.body)){var M=Phaser.Math.Angle.Between(l.x,l.y,e.player.x,e.player.y),N=l.body.velocity.x,w=l.body.velocity.y,Y=N*N+w*w,K=l.body.blocked&&(l.body.blocked.left||l.body.blocked.right||l.body.blocked.up||l.body.blocked.down)||l.body.touching&&(l.body.touching.left||l.body.touching.right||l.body.touching.up||l.body.touching.down)||Y<40,y=l.getData("turnBias")||0,m=l.getData("turnBiasT")||0;(K||m<=0)&&(y=(Math.random()<.5?-1:1)*(.35+Math.random()*.35),m=220+Math.random()*260),m-=v,l.setData("turnBias",y),l.setData("turnBiasT",m);var C=M+(m>0?y:0),b=74,A=Phaser.Math.Distance.Between(l.x,l.y,e.player.x,e.player.y),O=b+(A<260?26:0);l.body.setVelocity(Math.cos(C)*O,Math.sin(C)*O),l.rotation=C+Math.PI/2}}var Re=e.mines&&e.mines.getChildren?e.mines.getChildren():[],q=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[],U=!1;if(r.losAcc=(r.losAcc||0)+v,r.losAcc>=140&&(r.losAcc=0,U=!0),e.obsSpawnAcc+=v/1e3,e.obsSpawnAcc>=e.obsSpawnInterval){e.obsSpawnAcc=0;var J=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(J.length<70){for(var L=0,Z=0;Z<J.length;Z++){var ve=J[Z];ve.active&&Phaser.Math.Distance.Between(ve.x,ve.y,e.player.x,e.player.y)<520&&L++}if(L<12){var d=Math.random()*Math.PI*2,s=360+Math.random()*560,c=e.player.x+Math.cos(d)*s,i=e.player.y+Math.sin(d)*s,ke=u[Math.random()*u.length|0],T=e.obstacles.create(c,i,ke);T.setImmovable(!0),T.body&&typeof T.body.setAllowGravity=="function"&&T.body.setAllowGravity(!1);var Ae=.8+Math.random()*.6;T.setScale(Ae);var qe=Math.max(30,Math.floor(T.displayWidth*T.displayHeight/10));T.setData("maxHp",qe),T.setData("hp",qe),T.setAlpha(.55),typeof T.refreshBody=="function"&&T.refreshBody()}}}var g=r.target;if(g&&!g.active&&(g=null),!g)g=D(e),g&&(r.target=g,r.lastSwitch=a);else if(a-r.lastSwitch>=1e3){var se=D(e);if(se&&se!==g){var ze=Phaser.Math.Distance.Between(e.player.x,e.player.y,g.x,g.y),ea=Phaser.Math.Distance.Between(e.player.x,e.player.y,se.x,se.y);ea+40<ze&&(g=se,r.target=se,r.lastSwitch=a)}}if(r.targetDist=g&&g.active?Math.floor(Phaser.Math.Distance.Between(e.player.x,e.player.y,g.x,g.y)):0,U)for(var Pe=0;Pe<V.length;Pe++){var ue=V[Pe];if(ue.active){var ne=j(e,e.player.x,e.player.y,ue.x,ue.y);ue.setAlpha(ne?.18:1),ue.setData("blocked",ne)}}if(e.lockG.clear(),g&&g.active){e.lockG.lineStyle(2,16722731,.55),e.lockG.beginPath(),e.lockG.moveTo(e.player.x,e.player.y),e.lockG.lineTo(g.x,g.y),e.lockG.strokePath(),e.lockG.fillStyle(16722731,.9);var Me=7;e.lockG.beginPath(),e.lockG.moveTo(g.x,g.y-Me),e.lockG.lineTo(g.x+Me,g.y),e.lockG.lineTo(g.x,g.y+Me),e.lockG.lineTo(g.x-Me,g.y),e.lockG.closePath(),e.lockG.fillPath()}for(var V=e.enemies.getChildren(),Be=0;Be<V.length;Be++){var l=V[Be];if(l.active){var Ue=Phaser.Math.Angle.Between(l.x,l.y,e.player.x,e.player.y),aa=l.getData("spd")||180;e.physics.velocityFromRotation(Ue,aa,l.body.velocity),l.rotation=Ue+Math.PI/2;var A=Phaser.Math.Distance.Between(l.x,l.y,e.player.x,e.player.y);A<22&&(r.hp-=.2*(v/16.666))}}for(var Re=e.mines.getChildren(),Ce=0;Ce<Re.length;Ce++){var F=Re[Ce];if(F.active&&(!F.getData("armed")&&a>=(F.getData("armAt")||0)&&(F.setData("armed",!0),F.setAlpha(.95)),F.getData("armed")))for(var Ie=F.getData("radius")||120,Ye=Ie*Ie,o=0;o<V.length;o++){var Le=V[o];if(Le.active){var ie=Le.x-F.x,oe=Le.y-F.y;if(ie*ie+oe*oe<=Ye){for(var ta=F.getData("dmg")||18,Ee=0;Ee<V.length;Ee++){var te=V[Ee];if(te.active){var Ke=te.x-F.x,Xe=te.y-F.y;Ke*Ke+Xe*Xe<=Ye&&(te.setData("hp",(te.getData("hp")||20)-ta),te.getData("hp")<=0&&(te.destroy(),r.score+=1))}}var $e=e.add.circle(F.x,F.y,Ie,65484,.18);$e.setBlendMode(Phaser.BlendModes.ADD),e.time.delayedCall(180,function(){$e.active&&$e.destroy()}),F.destroy();break}}}}if(g&&g.active){var Fe=r.cfg.ai,Oe=Fe.prefer,ra=Phaser.Math.Distance.Between(e.player.x,e.player.y,g.x,g.y),we=360;Oe==="near"&&(we=220),Oe==="mid"&&(we=380),Oe==="far"&&(we=520);var la=r.hp/r.hpMax<Fe.fleeHp,He=Phaser.Math.Angle.Between(e.player.x,e.player.y,g.x,g.y),me=1;la||ra<we*Fe.keep?me=-1:me=1,e.physics.velocityFromRotation(He,r.speed*.85*me,e.player.body.velocity),e.player.rotation=me===1?He+Math.PI/2:He-Math.PI/2}var ce=r.cfg.wpnA,de=r.cfg.wpnB;a-r.lastA>=ce.cd*1e3&&(r.lastA=a,$(e,ce,a,"ba")),a-r.lastB>=de.cd*1e3&&(r.lastB=a,$(e,de,a,"bb")),e.rangeG.clear();for(var sa=Math.max(ce.range||0,de.range||0,0),je=200,Je=Math.max(1,Math.floor(sa/je));e.rangeTexts.length<Je;){var Qe=e.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3});Qe.setDepth(9),e.rangeTexts.push(Qe)}for(var Ve=0;Ve<e.rangeTexts.length;Ve++)e.rangeTexts[Ve].setVisible(!1);for(var Te=1;Te<=Je;Te++){var Se=Te*je;e.rangeG.lineStyle(1,16777215,.08),e.rangeG.strokeCircle(e.player.x,e.player.y,Se);var d=-Math.PI/4,na=e.player.x+Math.cos(d)*Se,ia=e.player.y+Math.sin(d)*Se,_e=e.rangeTexts[Te-1];_e.setText(String(Se)),_e.setPosition(na+6,ia-10),_e.setVisible(!0)}if(ce.range&&ce.range>0&&(e.rangeG.lineStyle(2,65484,.2),e.rangeG.strokeCircle(e.player.x,e.player.y,ce.range)),de.range&&de.range>0&&(e.rangeG.lineStyle(2,16732120,.18),e.rangeG.strokeCircle(e.player.x,e.player.y,de.range)),e.radarG){e.radarG.clear();var pe=e.radarX,he=e.radarY,ye=e.radarR;e.radarG.fillStyle(0,.35),e.radarG.fillCircle(pe,he,ye+8),e.radarG.lineStyle(2,65484,.22),e.radarG.strokeCircle(pe,he,ye),e.radarG.lineStyle(1,16777215,.08),e.radarG.strokeCircle(pe,he,ye*.66),e.radarG.strokeCircle(pe,he,ye*.33),e.radarG.fillStyle(65484,.9),e.radarG.fillCircle(pe,he,3);for(var We=e.radarRange,Ne=0;Ne<V.length;Ne++){var l=V[Ne];if(l.active){var ie=l.x-e.player.x,oe=l.y-e.player.y,s=Math.sqrt(ie*ie+oe*oe);if(!(s>We)){var oa=pe+ie/We*ye,ca=he+oe/We*ye,ne=!!l.getData("blocked");e.radarG.fillStyle(ne?16732120:16722731,ne?.7:.85),e.radarG.fillCircle(oa,ca,ne?2:2.5)}}}}var _=1e3;e.scorePanelG=e.add.graphics().setScrollFactor(0).setDepth(_),e.scoreLabelText=e.add.text(0,0,"SCORE",{fontFamily:"system-ui, sans-serif",fontSize:"12px",fontStyle:"700",fill:"#b8c6ff",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(_+1),e.scoreValueText=e.add.text(0,0,"0",{fontFamily:"system-ui, sans-serif",fontSize:"22px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:4}).setScrollFactor(0).setDepth(_+1),e.waveTimeText=e.add.text(0,0,"W1  00:00",{fontFamily:"system-ui, sans-serif",fontSize:"14px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(_+1),e.hpText=e.add.text(0,0,"HP 0/0",{fontFamily:"system-ui, sans-serif",fontSize:"18px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(_+1),e.expText=e.add.text(0,0,"EXP 0",{fontFamily:"system-ui, sans-serif",fontSize:"14px",fontStyle:"700",fill:"#ffd36b",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(_+1),e.hpBarG=e.add.graphics().setScrollFactor(0).setDepth(_),e.expBarG=e.add.graphics().setScrollFactor(0).setDepth(_),e.hpGroup=e.add.container(0,0,[e.hpText,e.expText,e.hpBarG,e.expBarG]).setScrollFactor(0).setDepth(_+1),e.weaponMainText=e.add.text(0,0,"MAIN",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(_+1),e.weaponSubText=e.add.text(0,0,"SUB",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(_+1),e.weaponG=e.add.graphics().setScrollFactor(0).setDepth(_+1),e.weaponGroup=e.add.container(0,0,[e.weaponG,e.weaponMainText,e.weaponSubText]).setScrollFactor(0).setDepth(_+1),ee(e,r,R),r.hp<=0&&(r.dead=!0,r.hp=0,xe(r.score,Math.floor(R||0),r.cfg))}catch(re){x("EXCEPTION: "+(re&&re.message?re.message:re)+(re&&re.stack?`
`+re.stack:"")),r.dead=!0}}S=new Phaser.Game(h)}function xe(t,p,n){try{S&&S.scene.pause()}catch{}B.showResult(t,p,n)}return x("bootGame called"),De(f),{destroy:()=>{try{S&&(S.destroy(!0),S=null)}catch{}}}},P=f=>{const B=document.getElementById(f);if(!B)throw new Error(`Missing required element: ${f}`);return B},ya=f=>{let S=Math.max(0,f|0);const x=Math.floor(S/36e5);S-=x*36e5;const X=Math.floor(S/6e4);S-=X*6e4;const H=Math.floor(S/1e3),E=S-H*1e3;return`${String(x).padStart(2,"0")}:${String(X).padStart(2,"0")}:${String(H).padStart(2,"0")}.${String(E).padStart(3,"0")}`},fa=f=>f.replace(/[&<>"]/g,B=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[B]??B),va=f=>{const B=P("debugBtn"),S=P("debugPanel"),x=P("mechLogPanel"),X=P("mechLogLines"),H=P("startPanel"),E=P("resultPanel"),le=P("toast"),ee=P("selFrame"),j=P("selWpnA"),ae=P("selWpnB"),Q=P("selAI"),ge=P("frameDesc"),fe=P("wpnADesc"),Ge=P("wpnBDesc"),De=P("aiDesc"),xe=P("kpi"),t=P("resultText"),p=P("resultKpi"),n=P("btnStart"),h=P("btnRetry");let r=!1;const u=[],G=[],k=window.location.hostname==="localhost"||window.location.search.includes("debug=1");document.body.classList.toggle("is-debug",k),B.style.display=k?"block":"none";const D=()=>{const c=G.map((i,l)=>{const o=l===G.length-1?"is-latest":"is-old";return`<div class='line ${i.cls} ${o}'>${ya(i.t)} ${fa(i.msg)}</div>`});for(;c.length<5;)c.push("<div class='line placeholder'>&nbsp;</div>");X.innerHTML=c.join("")};x.style.display="none",x.style.visibility="hidden",D();const $=s=>{const c=new Date().toISOString().slice(11,19);u.push(`[${c}] ${s}`),u.length>200&&u.shift(),S.textContent=u.join(`
`)},I=s=>{le.textContent=String(s)},a=(s,c,i)=>{x.style.display="block",x.style.visibility="visible";const l=`c-${s??"sys"}`;G.push({t:c|0,cls:l,msg:i}),G.length>5&&G.shift(),D(),x.style.opacity="0",requestAnimationFrame(()=>{x.style.opacity="0.8"}),window.clearTimeout(x.__fadeTimer),x.__fadeTimer=window.setTimeout(()=>{x.style.opacity="0.35"},2500)},v=(s,c)=>{s.innerHTML="",c.forEach(i=>{const l=document.createElement("option");l.value=i.id,l.textContent=i.name??i.id,s.appendChild(l)})},e=()=>{const s=f.frames.find(M=>M.id===ee.value),c=f.weapons.find(M=>M.id===j.value),i=f.weapons.find(M=>M.id===ae.value),l=f.ai.find(M=>M.id===Q.value);if(!s||!c||!i||!l)return;ge.textContent=`${s.desc}  (HP ${s.hp} / SPD ${s.speed})`,fe.textContent=`${c.desc}  (R ${c.range} / DPS ${c.dps})`,Ge.textContent=`${i.desc}  (R ${i.range} / DPS ${i.dps})`,De.textContent=l.desc,xe.innerHTML="";const o=(M,N)=>{const w=document.createElement("div");w.className=`pill ${N??""}`.trim(),w.textContent=M,xe.appendChild(w)};o(`FRAME: ${s.name}`,"good"),o(`MAIN: ${c.name}`),o(`SUB: ${i.name}`),o(`AI: ${l.name}`)};return v(ee,f.frames),v(j,f.weapons),v(ae,f.weapons),v(Q,f.ai),ee.value="middle",j.value="mg",ae.value="cannon",Q.value="balanced",ee.addEventListener("change",e),j.addEventListener("change",e),ae.addEventListener("change",e),Q.addEventListener("change",e),e(),H.classList.remove("hidden"),H.style.display="flex",E.classList.add("hidden"),E.style.display="none",x.style.display="none",x.style.visibility="hidden",k&&B.addEventListener("click",()=>{r=!r,S.style.display=r?"block":"none"}),window.addEventListener("error",s=>{var i;const c=s!=null&&s.message?s.message:String(s);$(`ERROR: ${c}${(i=s==null?void 0:s.error)!=null&&i.stack?`
${s.error.stack}`:""}`),I(`ERROR: ${c}`)}),{onStart:s=>n.addEventListener("click",s),onRetry:s=>h.addEventListener("click",s),hideStart:()=>{H.classList.add("hidden"),H.style.display="none",x.style.display="block",x.style.visibility="visible"},showStart:()=>{H.classList.remove("hidden"),H.style.display="flex",E.classList.add("hidden"),E.style.display="none",x.style.display="none",x.style.visibility="hidden"},hideResult:()=>{E.classList.add("hidden"),E.style.display="none"},showResultPanel:()=>{E.classList.remove("hidden"),E.style.display="flex",x.style.display="none",x.style.visibility="hidden"},getConfig:()=>({frameId:ee.value,wpnAId:j.value,wpnBId:ae.value,aiId:Q.value}),setToast:I,setDebug:$,pushMechLog:a,renderResult:(s,c,i)=>{const l=`SCORE: ${s}
TIME: ${c}s
FRAME: ${i.frame.name} / AI: ${i.ai.name}
MAIN: ${i.wpnA.name} / SUB: ${i.wpnB.name}`;t.textContent=l,p.innerHTML="";const o=(M,N)=>{const w=document.createElement("div");w.className=`pill ${N??""}`.trim(),w.textContent=M,p.appendChild(w)};o(`SCORE ${s}`,"good"),o(`TIME ${c}s`),o(i.frame.name),o(i.ai.name),o(`MAIN ${i.wpnA.name}`),o(`SUB ${i.wpnB.name}`,"bad")}}},W=va(be),ua=f=>{const B=da[f.frameId],S=Ze[f.wpnAId],x=Ze[f.wpnBId],X=pa[f.aiId];if(!B||!S||!x||!X)throw new Error("Invalid loadout selection.");return{frame:B,wpnA:S,wpnB:x,ai:X}};let z=null;const ma={toast:W.setToast,debug:W.setDebug,mechLog:W.pushMechLog,showResult:(f,B,S)=>{W.renderResult(f,B,S),W.showResultPanel()}};W.onStart(()=>{W.hideResult(),W.hideStart();const f=ua(W.getConfig());z==null||z.destroy(),z=ha(f,ma)});W.onRetry(()=>{W.hideResult(),W.showStart(),z==null||z.destroy(),z=null,W.setToast("READY")});
