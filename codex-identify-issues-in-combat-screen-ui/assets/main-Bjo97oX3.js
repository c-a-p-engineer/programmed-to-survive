import"./modulepreload-polyfill-B5Qt9EMX.js";const Ge={frames:[{id:"light",name:"LIGHT",hp:70,speed:240,en:100,enRegen:18,desc:"高速。薄い。回避で生きる。"},{id:"middle",name:"MIDDLE",hp:95,speed:210,en:120,enRegen:14,desc:"標準。バランス。"},{id:"heavy",name:"HEAVY",hp:130,speed:175,en:140,enRegen:11,desc:"鈍い。硬い。詰みづらい。"}],weapons:[{id:"mg",name:"Machinegun",type:"bullet",range:900,dps:14,cd:.1,speed:1e3,desc:"連射。見てて気持ちいい。",pierce:!1,explodeOnObstacle:!1},{id:"cannon",name:"Cannon",type:"bullet",range:1250,dps:22,cd:.55,speed:1250,desc:"高威力。遠距離。",pierce:!1,explodeOnObstacle:!1},{id:"missile",name:"Missile",type:"missile",range:1050,dps:18,cd:.7,speed:800,radius:110,desc:"範囲。雑に強い。",pierce:!1,explodeOnObstacle:!0},{id:"grenade",name:"Grenade",type:"lob",range:520,dps:16,cd:.85,speed:620,radius:85,desc:"近〜中。範囲。",pierce:!1,explodeOnObstacle:!0},{id:"blade",name:"Blade",type:"melee",range:120,dps:22,cd:.45,speed:0,desc:"近接。扇型。"},{id:"mine",name:"Mine",type:"mine",range:0,dps:22,cd:1.1,speed:0,radius:120,armMs:240,desc:"設置。踏ませる。"}],ai:[{id:"balanced",name:"Balanced",keep:.75,fleeHp:.18,prefer:"mid",desc:"無難。死ににくい。"},{id:"sniper",name:"Sniper",keep:.95,fleeHp:.12,prefer:"far",desc:"距離を取る。"},{id:"berserker",name:"Berserker",keep:.35,fleeHp:.08,prefer:"near",desc:"突っ込む。死にやすい。"},{id:"coward",name:"Coward",keep:.98,fleeHp:.35,prefer:"far",desc:"逃げる。稼げない。"},{id:"hunter",name:"Hunter",keep:.65,fleeHp:.1,prefer:"mid",desc:"近い敵を確実に。"}]},je=Object.fromEntries(Ge.weapons.map(v=>[v.id,v])),sa=Object.fromEntries(Ge.frames.map(v=>[v.id,v])),ia=Object.fromEntries(Ge.ai.map(v=>[v.id,v])),ca=(v,A)=>{let D=null;const T=A.debug,q=A.toast,Y=A.mechLog;function K(t,s,o){return t<s?s:t>o?o:t}function te(t,s,o,h){var r=h===1?10:h===2?18:6,x=h===2?16732120:16777215,M=t.add.circle(s,o,r,x,h===2?.18:.22);M.setBlendMode(Phaser.BlendModes.ADD),M.setDepth(5),t.tweens.add({targets:M,alpha:0,duration:160,onComplete:function(){M.active&&M.destroy()}})}function Q(t,s,o){var h=t.cameras.main,r=h.width,x=h.height,M=Math.max(4,Math.round(Math.min(r,x)*.02)),C=0,F=Math.max(44,Math.round(x*.07)),E=Math.max(108,Math.round(x*.17)),a=x-E;t.topPanelG&&(t.topPanelG.clear(),t.topPanelG.fillStyle(0,.62),t.topPanelG.fillRoundedRect(2,C,r-4,F,12),t.topPanelG.lineStyle(2,65484,.18),t.topPanelG.strokeRoundedRect(2,C,r-4,F,12));var u=Math.floor((o||0)*1e3),e=Math.floor(o||0),B=String(Math.floor(e/60)).padStart(2,"0"),d=String(e%60).padStart(2,"0");if(t.waveTimeText&&(t.waveTimeText.setText("W"+String(s.wave||1)+"  "+B+":"+d),t.waveTimeText.setPosition(M+2,C+M)),t.bottomPanelG&&(t.bottomPanelG.clear(),t.bottomPanelG.fillStyle(0,.55),t.bottomPanelG.fillRoundedRect(2,a,r-4,E,14),t.bottomPanelG.lineStyle(1,65484,.14),t.bottomPanelG.strokeRoundedRect(2,a,r-4,E,14)),t.mechInfoText){var l=s.cfg.wpnA?s.cfg.wpnA.name:"A",i=s.cfg.wpnB?s.cfg.wpnB.name:"B",c=s.cfg.frame?s.cfg.frame.name:"-",n=s.cfg.ai?s.cfg.ai.name:"-";t.mechInfoText.setText("FRAME "+c+"   AI "+n+"   MAIN "+l+"   SUB "+i),t.mechInfoText.setPosition(M+4,a+E-10)}if(t.hpGroup){var y=Math.max(0,s.hp|0),p=Math.max(1,s.hpMax??s.maxHp??1),I=Math.max(0,(s.exp??s.score??0)|0);if(t.hpText.setText("HP "+y+"/"+p),t.expText.setText("EXP "+I),t.hpText.setPosition(0,0),t.expText.setPosition(0,30),t.hpGroup.setPosition(M+2,a+M),t.hpBarG&&t.expBarG){var w=Math.max(140,Math.round(r*.34));t.hpBarG.clear(),t.hpBarG.fillStyle(16777215,.12),t.hpBarG.fillRoundedRect(0,22,w,12,6),t.hpBarG.fillStyle(65484,.8),t.hpBarG.fillRoundedRect(0,22,Math.max(6,w*K(y/p,0,1)),12,6),t.expBarG.clear(),t.expBarG.fillStyle(16777215,.08),t.expBarG.fillRoundedRect(0,52,w,8,5),t.expBarG.fillStyle(16765803,.55),t.expBarG.fillRoundedRect(0,52,Math.max(6,w*K(I%100/100,0,1)),8,5)}}if(t.weaponGroup){var _=s.cfg.wpnA?s.cfg.wpnA.name:"A",W=s.cfg.wpnB?s.cfg.wpnB.name:"B",V=function(L){return L.length>16?L.slice(0,15)+"…":L};t.weaponMainText.setText("MAIN "+V(_)),t.weaponSubText.setText("SUB "+V(W)),t.weaponMainText.setPosition(24,0),t.weaponSubText.setPosition(24,22),t.weaponGroup.setPosition(r-M-156,a+M),t.weaponG&&(t.weaponG.clear(),t.weaponG.fillStyle(65484,.9),t.weaponG.fillRoundedRect(0,2,16,16,4),t.weaponG.fillStyle(6728447,.9),t.weaponG.fillRoundedRect(0,24,16,16,4))}if(t.scorePanelG&&t.scoreLabelText&&t.scoreValueText){t.scoreLabelText.setText("SCORE"),t.scoreValueText.setText(String(s.score|0));var f=8,g=Math.max(t.scoreLabelText.width,t.scoreValueText.width)+f*2,b=t.scoreLabelText.height+t.scoreValueText.height+8,G=r-g-M,P=C+M;t.scorePanelG.clear(),t.scorePanelG.fillStyle(0,.62),t.scorePanelG.fillRoundedRect(G,P,g,b,12),t.scorePanelG.lineStyle(2,65484,.2),t.scorePanelG.strokeRoundedRect(G,P,g,b,12),t.scoreLabelText.setPosition(G+f,P+4),t.scoreValueText.setPosition(G+f,P+4+t.scoreLabelText.height)}if(t.radarG){var U=Math.round(Math.min(52,Math.max(40,r*.14)));t.radarR=U,t.radarX=r-U-M-2,t.radarY=a-U-M-6}t.prevScore!==(s.score|0)&&(t.prevScore=s.score|0,t.scoreValueText&&t.tweens.add({targets:t.scoreValueText,scale:1.12,duration:120,yoyo:!0,ease:"Quad.out"})),t.prevHp!=null&&(s.hp|0)<(t.prevHp|0)&&t.hpGroup&&t.tweens.add({targets:t.hpGroup,alpha:.4,duration:120,yoyo:!0,repeat:1}),t.prevHp=s.hp|0,s.battleTimeMs=u}function X(t,s,o,h,r){if(!t.obstacles)return!1;var x=new Phaser.Geom.Line(s,o,h,r),M=t.obstacles.getChildren(),C=h-s,F=r-o,E=Math.sqrt(C*C+F*F);if(E<1)return!1;for(var a=0;a<M.length;a++){var u=M[a];if(u.active){var e=u.body;if(e){var B=e.x+e.width*.5,d=e.y+e.height*.5,l=B-s,i=d-o,c=Math.sqrt(l*l+i*i);if(!(c<34)&&!(c>E-10)){var n=new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height);if(Phaser.Geom.Intersects.LineToRectangle(x,n))return!0}}}}return!1}function Z(t,s,o,h,r){if(!t.obstacles)return null;for(var x=new Phaser.Geom.Line(s,o,h,r),M=t.obstacles.getChildren(),C=null,F=1e9,E=0;E<M.length;E++){var a=M[E];if(!(!a.active||!a.body)){var u=a.body,e=new Phaser.Geom.Rectangle(u.x,u.y,u.width,u.height);if(Phaser.Geom.Intersects.LineToRectangle(x,e)){var B=u.x+u.width*.5,d=u.y+u.height*.5,l=Phaser.Math.Distance.Between(s,o,B,d);l<F&&(F=l,C=a)}}}return C}function j(t,s,o,h){var r=t.make.graphics({x:0,y:0,add:!1});r.clear(),r.fillStyle(h,1),r.fillTriangle(o/2,1,1,o-1,o-1,o-1),r.generateTexture(s,o,o),r.destroy()}function ge(t,s,o,h){var r=t.make.graphics({x:0,y:0,add:!1});r.clear(),r.fillStyle(0,.35),r.fillCircle(o/2+1,o/2+1,o/2),r.fillStyle(h,1),r.fillCircle(o/2,o/2,o/2-1),r.generateTexture(s,o,o),r.destroy()}function he(t,s,o,h,r){var x=t.make.graphics({x:0,y:0,add:!1});x.clear(),x.fillStyle(r,1),x.fillRoundedRect(0,0,o,h,10),x.lineStyle(2,16777215,.12),x.strokeRoundedRect(2,2,o-4,h-4,8),x.lineStyle(1,65484,.1),x.beginPath(),x.moveTo(8,h*.35),x.lineTo(o-8,h*.35),x.moveTo(8,h*.65),x.lineTo(o-8,h*.65),x.strokePath(),x.generateTexture(s,o,h),x.destroy()}function Te(t,s,o){var h=t.make.graphics({x:0,y:0,add:!1});h.clear(),h.fillStyle(724758,1),h.fillCircle(o/2,o/2,o/2),h.lineStyle(2,65484,.55),h.strokeCircle(o/2,o/2,o/2-2),h.fillStyle(65484,.18),h.fillCircle(o/2,o/2,o/2-4),h.generateTexture(s,o,o),h.destroy()}function be(t){if(D){try{D.destroy(!0)}catch{}D=null}var s=430,o=820,h={type:Phaser.AUTO,parent:"game",width:s,height:o,backgroundColor:"#05070b",physics:{default:"arcade",arcade:{debug:!1,gravity:{y:0}}},scene:{preload:x,create:M,update:E}};const r={cfg:t,hp:t.frame.hp,hpMax:t.frame.hp,en:t.frame.en,enMax:t.frame.en,enRegen:t.frame.enRegen,speed:t.frame.speed,score:0,t0:0,lastA:0,lastB:0,target:null,lastSwitch:0,targetDist:0,lastDelta:0,dead:!1};function x(){j(this,"p",30,65484),j(this,"e",26,16731469),ge(this,"ba",10,65484),ge(this,"bb",10,16732120),Te(this,"mn",22),he(this,"obA",140,90,2765892),he(this,"obB",220,130,2305082),he(this,"obC",110,180,2568772)}function M(){T("scene.create");var a=this;a.rangeTexts||(a.rangeTexts=[]),a.lockG||(a.lockG=a.add.graphics().setDepth(4)),a.radarG||(a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900),r.t0=a.time.now,a.physics.world.setBounds(-4e3,-4e3,8e3,8e3),a.player=a.physics.add.image(0,0,"p"),a.player.setDepth(2),a.player.setCircle(10),a.enemies=a.physics.add.group(),a.spawnAcc=0,a.spawnInterval=.85;function u(){var f=Math.random()*Math.PI*2,g=520+Math.random()*520,b=a.player.x+Math.cos(f)*g,G=a.player.y+Math.sin(f)*g,P=a.enemies.create(b,G,"e");return P.setData("hp",18),P.setData("blocked",!1),P.setRotation(Phaser.Math.Angle.Between(b,G,a.player.x,a.player.y)+Math.PI/2),P.setCollideWorldBounds(!1),P.setDepth(1),P}for(var e=0;e<6;e++)u();T("spawn init enemies="+a.enemies.getChildren().length),a.obsSpawnAcc=0,a.obsSpawnInterval=2.2,a.bullets=a.physics.add.group(),a.mines=a.physics.add.group(),a.obstacles=a.physics.add.staticGroup();for(var B=["obA","obB","obC"],d=0;d<25;d++){var l=Math.random()*Math.PI*2,i=280+Math.random()*1400,c=a.player.x+Math.cos(l)*i,n=a.player.y+Math.sin(l)*i,y=B[Math.random()*B.length|0],p=a.obstacles.create(c,n,y),I=p.body&&p.body.width?p.body.width:p.displayWidth||60,w=p.body&&p.body.height?p.body.height:p.displayHeight||60,_=Math.max(30,Math.floor(I*w/10));p.setData("maxHp",_),p.setData("hp",_),p.setAlpha(.55),p.setAlpha(.85),p.setRotation((Math.random()*2-1)*.18),p.setDepth(0),p.refreshBody()}a.obAcc=0,a.topPanelG=a.add.graphics().setScrollFactor(0).setDepth(11),a.bottomPanelG=a.add.graphics().setScrollFactor(0).setDepth(11),a.mechInfoText=a.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"16px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:5}).setScrollFactor(0).setDepth(12).setOrigin(0,1),a.barG=a.add.graphics().setScrollFactor(0).setDepth(10),a.rangeG=a.add.graphics().setDepth(0),a.lockG=a.add.graphics().setDepth(4),a.rangeTexts=[],a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900,a.cameras.main.startFollow(a.player,!0,.12,.12);var W=Math.max(r.cfg.wpnA.range||0,r.cfg.wpnB.range||0,520),V=K(680/W,.45,.9);a.cameras.main.setZoom(V),a.physics.add.overlap(a.bullets,a.enemies,function(f,g){if(!(!f.active||!g.active)){te(a,f.x,f.y,f.getData("pierce")?1:0);var b=f.getData("dmg")||6,G=g.getData("hp")||20;G-=b,g.setData("hp",G),f.destroy(),G<=0&&(g.destroy(),r.score+=1,r.kills=(r.kills||0)+1,Y("kill",r.battleTimeMs||0,"KILL ("+(f.getData("weaponName")||"WEAPON")+")"))}}),a.physics.add.overlap(a.bullets,a.obstacles,function(f,g){if(!(!f.active||!g.active)){var b=f.getData("bornAt")||0;if(!(b&&a.time.now-b<60)){var G=f.getData("aoe")||0,P=f.getData("dmg")||10;if(G>0&&f.getData("explodeOnObstacle")){te(a,f.x,f.y,2);var U=a.add.circle(f.x,f.y,G,16732120,.14);U.setBlendMode(Phaser.BlendModes.ADD),a.time.delayedCall(180,function(){U.active&&U.destroy()})}else te(a,f.x,f.y,1);var L=g.getData("hp"),z=g.getData("maxHp")||60;typeof L!="number"&&(L=z),L-=P,g.setData("hp",L);var R=Math.max(0,L/z);if(g.setAlpha(.25+R*.45),g.setTint){var N=R<.5?9082293:7306918;R<.25&&(N=9132634),g.setTint(N)}L<=0&&(te(a,g.x,g.y,2),g.destroy(),Y("obj",r.battleTimeMs||0,"OBJECT DESTROYED")),f.destroy()}}}),a.physics.add.collider(a.player,a.obstacles),a.physics.add.collider(a.enemies,a.obstacles),a.input.on("pointerdown",function(f){if(!r.dead){var g=Phaser.Math.Angle.Between(a.player.x,a.player.y,f.worldX,f.worldY);a.player.rotation=g+Math.PI/2,a.physics.velocityFromRotation(g,r.speed,a.player.body.velocity)}}),a.spawnAcc=0,a.dmgAcc=0,q("BATTLE STARTED"),T("Battle started")}function C(a){for(var u=a.enemies.getChildren(),e=0;e<2;e++){for(var B=null,d=1e18,l=0;l<u.length;l++){var i=u[l];if(i.active){var c=X(a,a.player.x,a.player.y,i.x,i.y);if(!(e===0&&c)){var n=i.x-a.player.x,y=i.y-a.player.y,p=n*n+y*y;p<d&&(d=p,B=i)}}}if(B)return B}return null}function F(a,u,e,B){if(!r.dead&&!(!r.target||!r.target.active)){var d=u,l=r.target,i=a.player.x,c=a.player.y,n=l.x,y=l.y,p=Phaser.Math.Distance.Between(i,c,n,y);if(!(d.range>0&&p>d.range)){if(d.type!=="melee"&&d.type!=="mine"){var I=X(a,i,c,n,y);if(I){var w=Z(a,i,c,n,y);if(w&&w.active)n=w.x,y=w.y,w.body&&(n=w.body.x+w.body.width*.5,y=w.body.y+w.body.height*.5),a._breakCoverAcc=(a._breakCoverAcc||0)+(r.lastDelta||0),a._breakCoverAcc>1200&&(a._breakCoverAcc=0,Y("obj",r.battleTimeMs||0,"BREAK COVER → obstacle"));else return}}if(d.type==="melee"){var _=Math.PI*.65,W=Phaser.Math.Angle.Between(i,c,n,y);a.player.rotation=W+Math.PI/2,a.slashG||(a.slashG=a.add.graphics(),a.slashG.setDepth(2)),a.slashG.clear(),a.slashG.fillStyle(65484,.1),a.slashG.lineStyle(2,65484,.28),a.slashG.beginPath(),a.slashG.slice(i,c,d.range,W-_/2,W+_/2,!1),a.slashG.closePath(),a.slashG.fillPath(),a.slashG.strokePath(),a.time.delayedCall(90,function(){a.slashG&&a.slashG.clear()});for(var V=a.enemies.getChildren(),f=Math.max(10,Math.floor(d.dps*d.cd)),g=0;g<V.length;g++){var b=V[g];if(b.active){var G=b.x-i,P=b.y-c,U=Math.sqrt(G*G+P*P);if(!(U>d.range)){var L=Math.atan2(P,G),z=Phaser.Math.Angle.Wrap(L-W);Math.abs(z)<=_/2&&(b.setData("hp",(b.getData("hp")||20)-f),b.getData("hp")<=0&&(b.destroy(),r.score+=1))}}}return}if(d.type==="mine"){var R=a.physics.add.image(i,c,"mn");R.setDepth(1),R.setCircle(10),R.body.setImmovable(!0),R.body.setVelocity(0,0),R.setAlpha(.55),R.setData("armed",!1),R.setData("armAt",e+(d.armMs||240)),R.setData("radius",d.radius||120),R.setData("dmg",Math.max(12,Math.floor(d.dps*.9))),a.mines.add(R);return}var N=Phaser.Math.Angle.Between(i,c,n,y);a.player.rotation=N+Math.PI/2;var fe=Math.cos(N)*26,ye=Math.sin(N)*26,S=a.physics.add.image(i+fe,c+ye,B);S.setDepth(3),S.setCircle(4),S.setData("dmg",Math.max(6,Math.floor(d.dps*d.cd))),S.setData("bornAt",e),S.setData("pierce",!!d.pierce),S.setData("explodeOnObstacle",!!d.explodeOnObstacle),a.bullets.add(S),a.physics.velocityFromRotation(N,d.speed||1e3,S.body.velocity);var xe=Math.floor((d.range||900)/(d.speed||1e3)*1e3)+1200;a.time.delayedCall(xe,function(){S.active&&S.destroy()}),(d.type==="lob"||d.type==="missile")&&(S.setData("aoe",d.radius||90),S.setData("explodeOnObstacle",!!d.explodeOnObstacle))}}}function E(a,u){var e=this,B=r.startMs!=null?(e.time.now-r.startMs)/1e3:0;r.lastDelta=u;try{if(e._dbgAcc=(e._dbgAcc||0)+u,e._dbgAcc>700&&(e._dbgAcc=0,T("tick "+Math.floor(a))),r.dead)return;if(r.en=K(r.en+r.enRegen*(u/1e3),0,r.enMax),e.spawnAcc+=u/1e3,e.spawnAcc>=e.spawnInterval&&(e.spawnAcc=0,e.enemies.getChildren().length<26)){var d=Math.random()*Math.PI*2,l=560+Math.random()*660,i=e.player.x+Math.cos(d)*l,c=e.player.y+Math.sin(d)*l,n=e.enemies.create(i,c,"e");n.setData("hp",18),n.setData("blocked",!1),n.setRotation(Phaser.Math.Angle.Between(i,c,e.player.x,e.player.y)+Math.PI/2),n.setDepth(1)}e._cntAcc=(e._cntAcc||0)+u,e._cntAcc>2500&&(e._cntAcc=0,T("counts enemies="+e.enemies.getChildren().length+" obstacles="+(e.obstacles?e.obstacles.getChildren().length:0)+" bullets="+e.bullets.getChildren().length));for(var O=e.enemies&&e.enemies.getChildren?e.enemies.getChildren():[],y=0;y<O.length;y++){var n=O[y];if(!(!n.active||!n.body)){var p=Phaser.Math.Angle.Between(n.x,n.y,e.player.x,e.player.y),I=n.body.velocity.x,w=n.body.velocity.y,_=I*I+w*w,W=n.body.blocked&&(n.body.blocked.left||n.body.blocked.right||n.body.blocked.up||n.body.blocked.down)||n.body.touching&&(n.body.touching.left||n.body.touching.right||n.body.touching.up||n.body.touching.down)||_<40,V=n.getData("turnBias")||0,f=n.getData("turnBiasT")||0;(W||f<=0)&&(V=(Math.random()<.5?-1:1)*(.35+Math.random()*.35),f=220+Math.random()*260),f-=u,n.setData("turnBias",V),n.setData("turnBiasT",f);var g=p+(f>0?V:0),b=74,G=Phaser.Math.Distance.Between(n.x,n.y,e.player.x,e.player.y),P=b+(G<260?26:0);n.body.setVelocity(Math.cos(g)*P,Math.sin(g)*P),n.rotation=g+Math.PI/2}}var Ae=e.mines&&e.mines.getChildren?e.mines.getChildren():[],U=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(e.obsSpawnAcc+=u/1e3,e.obsSpawnAcc>=e.obsSpawnInterval){e.obsSpawnAcc=0;var L=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(L.length<70){for(var z=0,R=0;R<L.length;R++){var N=L[R];N.active&&Phaser.Math.Distance.Between(N.x,N.y,e.player.x,e.player.y)<520&&z++}if(z<12){var d=Math.random()*Math.PI*2,l=360+Math.random()*560,i=e.player.x+Math.cos(d)*l,c=e.player.y+Math.sin(d)*l,fe=70+Math.random()*160,ye=50+Math.random()*150,S=e.obstacles.create(i,c,"ob");S.setImmovable(!0),S.body&&typeof S.body.setAllowGravity=="function"&&S.body.setAllowGravity(!1),S.body&&typeof S.body.setSize=="function"&&S.body.setSize(fe,ye,!0),S.displayWidth=fe,S.displayHeight=ye;var xe=Math.max(30,Math.floor(fe*ye/10));S.setData("maxHp",xe),S.setData("hp",xe),S.setAlpha(.55),typeof S.refreshBody=="function"&&S.refreshBody()}}}var m=r.target;if(m&&!m.active&&(m=null),!m)m=C(e),m&&(r.target=m,r.lastSwitch=a);else if(a-r.lastSwitch>=1e3){var re=C(e);if(re&&re!==m){var Je=Phaser.Math.Distance.Between(e.player.x,e.player.y,m.x,m.y),Qe=Phaser.Math.Distance.Between(e.player.x,e.player.y,re.x,re.y);Qe+40<Je&&(m=re,r.target=re,r.lastSwitch=a)}}r.targetDist=m&&m.active?Math.floor(Phaser.Math.Distance.Between(e.player.x,e.player.y,m.x,m.y)):0;for(var Pe=0;Pe<O.length;Pe++){var ve=O[Pe];if(ve.active){var ne=X(e,e.player.x,e.player.y,ve.x,ve.y);ve.setAlpha(ne?.18:1),ve.setData("blocked",ne)}}if(e.lockG.clear(),m&&m.active){e.lockG.lineStyle(2,16722731,.55),e.lockG.beginPath(),e.lockG.moveTo(e.player.x,e.player.y),e.lockG.lineTo(m.x,m.y),e.lockG.strokePath(),e.lockG.fillStyle(16722731,.9);var Me=7;e.lockG.beginPath(),e.lockG.moveTo(m.x,m.y-Me),e.lockG.lineTo(m.x+Me,m.y),e.lockG.lineTo(m.x,m.y+Me),e.lockG.lineTo(m.x-Me,m.y),e.lockG.closePath(),e.lockG.fillPath()}for(var O=e.enemies.getChildren(),ke=0;ke<O.length;ke++){var n=O[ke];if(n.active){var Ne=Phaser.Math.Angle.Between(n.x,n.y,e.player.x,e.player.y),Ze=n.getData("spd")||180;e.physics.velocityFromRotation(Ne,Ze,n.body.velocity),n.rotation=Ne+Math.PI/2;var G=Phaser.Math.Distance.Between(n.x,n.y,e.player.x,e.player.y);G<22&&(r.hp-=.2*(u/16.666))}}for(var Ae=e.mines.getChildren(),Be=0;Be<Ae.length;Be++){var $=Ae[Be];if($.active&&(!$.getData("armed")&&a>=($.getData("armAt")||0)&&($.setData("armed",!0),$.setAlpha(.95)),$.getData("armed")))for(var Re=$.getData("radius")||120,We=Re*Re,y=0;y<O.length;y++){var Ce=O[y];if(Ce.active){var le=Ce.x-$.x,oe=Ce.y-$.y;if(le*le+oe*oe<=We){for(var ze=$.getData("dmg")||18,Ie=0;Ie<O.length;Ie++){var ee=O[Ie];if(ee.active){var Ue=ee.x-$.x,qe=ee.y-$.y;Ue*Ue+qe*qe<=We&&(ee.setData("hp",(ee.getData("hp")||20)-ze),ee.getData("hp")<=0&&(ee.destroy(),r.score+=1))}}var Ee=e.add.circle($.x,$.y,Re,65484,.18);Ee.setBlendMode(Phaser.BlendModes.ADD),e.time.delayedCall(180,function(){Ee.active&&Ee.destroy()}),$.destroy();break}}}}if(m&&m.active){var Le=r.cfg.ai,$e=Le.prefer,ea=Phaser.Math.Distance.Between(e.player.x,e.player.y,m.x,m.y),we=360;$e==="near"&&(we=220),$e==="mid"&&(we=380),$e==="far"&&(we=520);var aa=r.hp/r.hpMax<Le.fleeHp,Fe=Phaser.Math.Angle.Between(e.player.x,e.player.y,m.x,m.y),ue=1;aa||ea<we*Le.keep?ue=-1:ue=1,e.physics.velocityFromRotation(Fe,r.speed*.85*ue,e.player.body.velocity),e.player.rotation=ue===1?Fe+Math.PI/2:Fe-Math.PI/2}var se=r.cfg.wpnA,ie=r.cfg.wpnB;a-r.lastA>=se.cd*1e3&&(r.lastA=a,F(e,se,a,"ba")),a-r.lastB>=ie.cd*1e3&&(r.lastB=a,F(e,ie,a,"bb")),e.rangeG.clear();for(var ta=Math.max(se.range||0,ie.range||0,0),Ye=200,Ke=Math.max(1,Math.floor(ta/Ye));e.rangeTexts.length<Ke;){var Xe=e.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3});Xe.setDepth(9),e.rangeTexts.push(Xe)}for(var Oe=0;Oe<e.rangeTexts.length;Oe++)e.rangeTexts[Oe].setVisible(!1);for(var Se=1;Se<=Ke;Se++){var De=Se*Ye;e.rangeG.lineStyle(1,16777215,.08),e.rangeG.strokeCircle(e.player.x,e.player.y,De);var d=-Math.PI/4,ra=e.player.x+Math.cos(d)*De,na=e.player.y+Math.sin(d)*De,He=e.rangeTexts[Se-1];He.setText(String(De)),He.setPosition(ra+6,na-10),He.setVisible(!0)}if(se.range&&se.range>0&&(e.rangeG.lineStyle(2,65484,.2),e.rangeG.strokeCircle(e.player.x,e.player.y,se.range)),ie.range&&ie.range>0&&(e.rangeG.lineStyle(2,16732120,.18),e.rangeG.strokeCircle(e.player.x,e.player.y,ie.range)),e.radarG){e.radarG.clear();var ce=e.radarX,de=e.radarY,pe=e.radarR;e.radarG.fillStyle(0,.35),e.radarG.fillCircle(ce,de,pe+8),e.radarG.lineStyle(2,65484,.22),e.radarG.strokeCircle(ce,de,pe),e.radarG.lineStyle(1,16777215,.08),e.radarG.strokeCircle(ce,de,pe*.66),e.radarG.strokeCircle(ce,de,pe*.33),e.radarG.fillStyle(65484,.9),e.radarG.fillCircle(ce,de,3);for(var _e=e.radarRange,Ve=0;Ve<O.length;Ve++){var n=O[Ve];if(n.active){var le=n.x-e.player.x,oe=n.y-e.player.y,l=Math.sqrt(le*le+oe*oe);if(!(l>_e)){var la=ce+le/_e*pe,oa=de+oe/_e*pe,ne=!!n.getData("blocked");e.radarG.fillStyle(ne?16732120:16722731,ne?.7:.85),e.radarG.fillCircle(la,oa,ne?2:2.5)}}}}e.scorePanelG=e.add.graphics().setScrollFactor(0).setDepth(11),e.scoreLabelText=e.add.text(0,0,"SCORE",{fontFamily:"system-ui, sans-serif",fontSize:"12px",fontStyle:"700",fill:"#b8c6ff",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.scoreValueText=e.add.text(0,0,"0",{fontFamily:"system-ui, sans-serif",fontSize:"22px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:4}).setScrollFactor(0).setDepth(12),e.waveTimeText=e.add.text(0,0,"W1  00:00",{fontFamily:"system-ui, sans-serif",fontSize:"14px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.hpText=e.add.text(0,0,"HP 0/0",{fontFamily:"system-ui, sans-serif",fontSize:"18px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.expText=e.add.text(0,0,"EXP 0",{fontFamily:"system-ui, sans-serif",fontSize:"14px",fontStyle:"700",fill:"#ffd36b",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.hpBarG=e.add.graphics().setScrollFactor(0).setDepth(11),e.expBarG=e.add.graphics().setScrollFactor(0).setDepth(11),e.hpGroup=e.add.container(0,0,[e.hpText,e.expText,e.hpBarG,e.expBarG]).setScrollFactor(0).setDepth(12),e.weaponMainText=e.add.text(0,0,"MAIN",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.weaponSubText=e.add.text(0,0,"SUB",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.weaponG=e.add.graphics().setScrollFactor(0).setDepth(12),e.weaponGroup=e.add.container(0,0,[e.weaponG,e.weaponMainText,e.weaponSubText]).setScrollFactor(0).setDepth(12),Q(e,r,B),r.hp<=0&&(r.dead=!0,r.hp=0,me(r.score,Math.floor(B||0),r.cfg))}catch(ae){T("EXCEPTION: "+(ae&&ae.message?ae.message:ae)+(ae&&ae.stack?`
`+ae.stack:"")),r.dead=!0}}D=new Phaser.Game(h)}function me(t,s,o){try{D&&D.scene.pause()}catch{}A.showResult(t,s,o)}return T("bootGame called"),be(v),{destroy:()=>{try{D&&(D.destroy(!0),D=null)}catch{}}}},k=v=>{const A=document.getElementById(v);if(!A)throw new Error(`Missing required element: ${v}`);return A},da=v=>{let D=Math.max(0,v|0);const T=Math.floor(D/36e5);D-=T*36e5;const q=Math.floor(D/6e4);D-=q*6e4;const Y=Math.floor(D/1e3),K=D-Y*1e3;return`${String(T).padStart(2,"0")}:${String(q).padStart(2,"0")}:${String(Y).padStart(2,"0")}.${String(K).padStart(3,"0")}`},pa=v=>v.replace(/[&<>"]/g,A=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[A]??A),ha=v=>{const A=k("debugBtn"),D=k("debugPanel"),T=k("mechLogPanel"),q=k("mechLogLines"),Y=k("startPanel"),K=k("resultPanel"),te=k("toast"),Q=k("selFrame"),X=k("selWpnA"),Z=k("selWpnB"),j=k("selAI"),ge=k("frameDesc"),he=k("wpnADesc"),Te=k("wpnBDesc"),be=k("aiDesc"),me=k("kpi"),t=k("resultText"),s=k("resultKpi"),o=k("btnStart"),h=k("btnRetry");let r=!1;const x=[],M=[],C=window.location.hostname==="localhost"||window.location.search.includes("debug=1");document.body.classList.toggle("is-debug",C),A.style.display=C?"block":"none";const F=l=>{const i=new Date().toISOString().slice(11,19);x.push(`[${i}] ${l}`),x.length>200&&x.shift(),D.textContent=x.join(`
`)},E=l=>{te.textContent=String(l)},a=(l,i,c)=>{T.style.display="block";const n=`c-${l??"sys"}`;M.push({t:i|0,cls:n,msg:c}),M.length>5&&M.shift();const y=5,p=M.map((I,w)=>{const _=w===M.length-1?"is-latest":"is-old";return`<div class='line ${I.cls} ${_}'>${da(I.t)} ${pa(I.msg)}</div>`});for(;p.length<y;)p.push("<div class='line placeholder'>&nbsp;</div>");q.innerHTML=p.join(""),T.style.opacity="0",requestAnimationFrame(()=>{T.style.opacity="0.8"}),window.clearTimeout(T.__fadeTimer),T.__fadeTimer=window.setTimeout(()=>{T.style.opacity="0.35"},2500)},u=(l,i)=>{l.innerHTML="",i.forEach(c=>{const n=document.createElement("option");n.value=c.id,n.textContent=c.name??c.id,l.appendChild(n)})},e=()=>{const l=v.frames.find(p=>p.id===Q.value),i=v.weapons.find(p=>p.id===X.value),c=v.weapons.find(p=>p.id===Z.value),n=v.ai.find(p=>p.id===j.value);if(!l||!i||!c||!n)return;ge.textContent=`${l.desc}  (HP ${l.hp} / SPD ${l.speed})`,he.textContent=`${i.desc}  (R ${i.range} / DPS ${i.dps})`,Te.textContent=`${c.desc}  (R ${c.range} / DPS ${c.dps})`,be.textContent=n.desc,me.innerHTML="";const y=(p,I)=>{const w=document.createElement("div");w.className=`pill ${I??""}`.trim(),w.textContent=p,me.appendChild(w)};y(`FRAME: ${l.name}`,"good"),y(`MAIN: ${i.name}`),y(`SUB: ${c.name}`),y(`AI: ${n.name}`)};return u(Q,v.frames),u(X,v.weapons),u(Z,v.weapons),u(j,v.ai),Q.value="middle",X.value="mg",Z.value="cannon",j.value="balanced",Q.addEventListener("change",e),X.addEventListener("change",e),Z.addEventListener("change",e),j.addEventListener("change",e),e(),C&&A.addEventListener("click",()=>{r=!r,D.style.display=r?"block":"none"}),window.addEventListener("error",l=>{var c;const i=l!=null&&l.message?l.message:String(l);F(`ERROR: ${i}${(c=l==null?void 0:l.error)!=null&&c.stack?`
${l.error.stack}`:""}`),E(`ERROR: ${i}`)}),{onStart:l=>o.addEventListener("click",l),onRetry:l=>h.addEventListener("click",l),hideStart:()=>Y.classList.add("hidden"),showStart:()=>Y.classList.remove("hidden"),hideResult:()=>K.classList.add("hidden"),showResultPanel:()=>K.classList.remove("hidden"),getConfig:()=>({frameId:Q.value,wpnAId:X.value,wpnBId:Z.value,aiId:j.value}),setToast:E,setDebug:F,pushMechLog:a,renderResult:(l,i,c)=>{const n=`SCORE: ${l}
TIME: ${i}s
FRAME: ${c.frame.name} / AI: ${c.ai.name}
MAIN: ${c.wpnA.name} / SUB: ${c.wpnB.name}`;t.textContent=n,s.innerHTML="";const y=(p,I)=>{const w=document.createElement("div");w.className=`pill ${I??""}`.trim(),w.textContent=p,s.appendChild(w)};y(`SCORE ${l}`,"good"),y(`TIME ${i}s`),y(c.frame.name),y(c.ai.name),y(`MAIN ${c.wpnA.name}`),y(`SUB ${c.wpnB.name}`,"bad")}}},H=ha(Ge),fa=v=>{const A=sa[v.frameId],D=je[v.wpnAId],T=je[v.wpnBId],q=ia[v.aiId];if(!A||!D||!T||!q)throw new Error("Invalid loadout selection.");return{frame:A,wpnA:D,wpnB:T,ai:q}};let J=null;const ya={toast:H.setToast,debug:H.setDebug,mechLog:H.pushMechLog,showResult:(v,A,D)=>{H.renderResult(v,A,D),H.showResultPanel()}};H.onStart(()=>{H.hideResult(),H.hideStart();const v=fa(H.getConfig());J==null||J.destroy(),J=ca(v,ya)});H.onRetry(()=>{H.hideResult(),H.showStart(),J==null||J.destroy(),J=null,H.setToast("READY")});
