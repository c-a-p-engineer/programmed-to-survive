import"./modulepreload-polyfill-B5Qt9EMX.js";const Ge={frames:[{id:"light",name:"LIGHT",hp:70,speed:240,en:100,enRegen:18,desc:"高速。薄い。回避で生きる。"},{id:"middle",name:"MIDDLE",hp:95,speed:210,en:120,enRegen:14,desc:"標準。バランス。"},{id:"heavy",name:"HEAVY",hp:130,speed:175,en:140,enRegen:11,desc:"鈍い。硬い。詰みづらい。"}],weapons:[{id:"mg",name:"Machinegun",type:"bullet",range:900,dps:14,cd:.1,speed:1e3,desc:"連射。見てて気持ちいい。",pierce:!1,explodeOnObstacle:!1},{id:"cannon",name:"Cannon",type:"bullet",range:1250,dps:22,cd:.55,speed:1250,desc:"高威力。遠距離。",pierce:!1,explodeOnObstacle:!1},{id:"missile",name:"Missile",type:"missile",range:1050,dps:18,cd:.7,speed:800,radius:110,desc:"範囲。雑に強い。",pierce:!1,explodeOnObstacle:!0},{id:"grenade",name:"Grenade",type:"lob",range:520,dps:16,cd:.85,speed:620,radius:85,desc:"近〜中。範囲。",pierce:!1,explodeOnObstacle:!0},{id:"blade",name:"Blade",type:"melee",range:120,dps:22,cd:.45,speed:0,desc:"近接。扇型。"},{id:"mine",name:"Mine",type:"mine",range:0,dps:22,cd:1.1,speed:0,radius:120,armMs:240,desc:"設置。踏ませる。"}],ai:[{id:"balanced",name:"Balanced",keep:.75,fleeHp:.18,prefer:"mid",desc:"無難。死ににくい。"},{id:"sniper",name:"Sniper",keep:.95,fleeHp:.12,prefer:"far",desc:"距離を取る。"},{id:"berserker",name:"Berserker",keep:.35,fleeHp:.08,prefer:"near",desc:"突っ込む。死にやすい。"},{id:"coward",name:"Coward",keep:.98,fleeHp:.35,prefer:"far",desc:"逃げる。稼げない。"},{id:"hunter",name:"Hunter",keep:.65,fleeHp:.1,prefer:"mid",desc:"近い敵を確実に。"}]},je=Object.fromEntries(Ge.weapons.map(f=>[f.id,f])),oa=Object.fromEntries(Ge.frames.map(f=>[f.id,f])),da=Object.fromEntries(Ge.ai.map(f=>[f.id,f])),ca=(f,R)=>{let S=null;const g=R.debug,K=R.toast,V=R.mechLog;function $(t,i,s){return t<i?i:t>s?s:t}function te(t,i,s,c){var l=c===1?10:c===2?18:6,m=c===2?16732120:16777215,M=t.add.circle(i,s,l,m,c===2?.18:.22);M.setBlendMode(Phaser.BlendModes.ADD),M.setDepth(5),t.tweens.add({targets:M,alpha:0,duration:160,onComplete:function(){M.active&&M.destroy()}})}function Q(t,i,s){var c=t.cameras.main,l=c.width,m=c.height,M=Math.max(2,Math.round(Math.min(l,m)*.015)),C=2,O=0,H=Math.max(96,Math.round(m*.15)),a=m-H;t.topPanelG&&t.topPanelG.clear();var x=Math.floor((s||0)*1e3),e=Math.floor(s||0),G=String(Math.floor(e/60)).padStart(2,"0"),o=String(e%60).padStart(2,"0");if(t.waveTimeText&&(t.waveTimeText.setText("W"+String(i.wave||1)+"  "+G+":"+o),t.waveTimeText.setPosition(C+M,O+M),t.waveTimeText.setVisible(!0),t.waveTimeText.setAlpha(1)),t.uiLayer&&(t.uiLayer.setVisible(!0),t.uiLayer.setAlpha(1),t.uiLayer.setPosition(0,0)),t.bottomPanelG&&t.bottomPanelG.clear(),t.mechInfoText){var T=i.cfg.wpnA?i.cfg.wpnA.name:"A",n=i.cfg.wpnB?i.cfg.wpnB.name:"B",d=i.cfg.frame?i.cfg.frame.name:"-",r=i.cfg.ai?i.cfg.ai.name:"-";t.mechInfoText.setText("FRAME "+d+"   AI "+r+"   MAIN "+T+"   SUB "+n),t.mechInfoText.setPosition(M+4,a+H-10)}if(t.hpGroup){var y=Math.max(0,i.hp|0),p=Math.max(1,i.hpMax??i.maxHp??1),k=Math.max(0,(i.exp??i.score??0)|0);if(t.hpText.setText("HP "+y+"/"+p),t.expText.setText("EXP "+k),t.hpText.setPosition(0,0),t.expText.setPosition(0,30),t.hpGroup.setPosition(C+M,a+M),t.hpGroup.setVisible(!0),t.hpGroup.setAlpha(1),t.hpBarG&&t.expBarG){var b=Math.max(128,Math.round(l*.32));t.hpBarG.clear(),t.hpBarG.fillStyle(16777215,.12),t.hpBarG.fillRoundedRect(0,22,b,12,6),t.hpBarG.fillStyle(65484,.8),t.hpBarG.fillRoundedRect(0,22,Math.max(6,b*$(y/p,0,1)),12,6),t.expBarG.clear(),t.expBarG.fillStyle(16777215,.08),t.expBarG.fillRoundedRect(0,52,b,8,5),t.expBarG.fillStyle(16765803,.55),t.expBarG.fillRoundedRect(0,52,Math.max(6,b*$(k%100/100,0,1)),8,5)}}if(t.weaponGroup){var L=i.cfg.wpnA?i.cfg.wpnA.name:"A",q=i.cfg.wpnB?i.cfg.wpnB.name:"B",W=function(E){return E.length>16?E.slice(0,15)+"…":E};t.weaponMainText.setText("MAIN "+W(L)),t.weaponSubText.setText("SUB "+W(q)),t.weaponMainText.setPosition(24,0),t.weaponSubText.setPosition(24,22),t.weaponGroup.setPosition(l-C-M-150,a+M),t.weaponGroup.setVisible(!0),t.weaponGroup.setAlpha(1),t.weaponG&&(t.weaponG.clear(),t.weaponG.fillStyle(65484,.9),t.weaponG.fillRoundedRect(0,2,16,16,4),t.weaponG.fillStyle(6728447,.9),t.weaponG.fillRoundedRect(0,24,16,16,4))}if(t.scorePanelG&&t.scoreLabelText&&t.scoreValueText){t.scoreLabelText.setText("SCORE"),t.scoreValueText.setText(String(i.score|0));var h=8,v=Math.max(t.scoreLabelText.width,t.scoreValueText.width)+h*2,A=t.scoreLabelText.height+t.scoreValueText.height+8,D=l-v-C,P=O+C;t.scorePanelG.clear(),t.scorePanelG.fillStyle(0,.45),t.scorePanelG.fillRoundedRect(D,P,v,A,12),t.scorePanelG.lineStyle(2,65484,.16),t.scorePanelG.strokeRoundedRect(D,P,v,A,12),t.scoreLabelText.setPosition(D+h,P+4),t.scoreValueText.setPosition(D+h,P+4+t.scoreLabelText.height),t.scoreLabelText.setVisible(!0),t.scoreValueText.setVisible(!0),t.scoreLabelText.setAlpha(1),t.scoreValueText.setAlpha(1)}if(t.radarG){var Y=Math.round(Math.min(48,Math.max(36,l*.13)));t.radarR=Y,t.radarX=l-Y-C-M,t.radarY=a-Y-M-4}t.prevScore!==(i.score|0)&&(t.prevScore=i.score|0,t.scoreValueText&&t.tweens.add({targets:t.scoreValueText,scale:1.12,duration:120,yoyo:!0,ease:"Quad.out"})),t.prevHp!=null&&(i.hp|0)<(t.prevHp|0)&&t.hpGroup&&t.tweens.add({targets:t.hpGroup,alpha:.4,duration:120,yoyo:!0,repeat:1}),t.prevHp=i.hp|0,i.battleTimeMs=x}function X(t,i,s,c,l){if(!t.obstacles)return!1;var m=new Phaser.Geom.Line(i,s,c,l),M=t.obstacles.getChildren(),C=c-i,O=l-s,H=Math.sqrt(C*C+O*O);if(H<1)return!1;for(var a=0;a<M.length;a++){var x=M[a];if(x.active){var e=x.body;if(e){var G=e.x+e.width*.5,o=e.y+e.height*.5,T=G-i,n=o-s,d=Math.sqrt(T*T+n*n);if(!(d<34)&&!(d>H-10)){var r=new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height);if(Phaser.Geom.Intersects.LineToRectangle(m,r))return!0}}}}return!1}function Z(t,i,s,c,l){if(!t.obstacles)return null;for(var m=new Phaser.Geom.Line(i,s,c,l),M=t.obstacles.getChildren(),C=null,O=1e9,H=0;H<M.length;H++){var a=M[H];if(!(!a.active||!a.body)){var x=a.body,e=new Phaser.Geom.Rectangle(x.x,x.y,x.width,x.height);if(Phaser.Geom.Intersects.LineToRectangle(m,e)){var G=x.x+x.width*.5,o=x.y+x.height*.5,T=Phaser.Math.Distance.Between(i,s,G,o);T<O&&(O=T,C=a)}}}return C}function j(t,i,s,c){var l=t.make.graphics({x:0,y:0,add:!1});l.clear(),l.fillStyle(c,1),l.fillTriangle(s/2,1,1,s-1,s-1,s-1),l.generateTexture(i,s,s),l.destroy()}function ge(t,i,s,c){var l=t.make.graphics({x:0,y:0,add:!1});l.clear(),l.fillStyle(0,.35),l.fillCircle(s/2+1,s/2+1,s/2),l.fillStyle(c,1),l.fillCircle(s/2,s/2,s/2-1),l.generateTexture(i,s,s),l.destroy()}function he(t,i,s,c,l){var m=t.make.graphics({x:0,y:0,add:!1});m.clear(),m.fillStyle(l,1),m.fillRoundedRect(0,0,s,c,10),m.lineStyle(2,16777215,.12),m.strokeRoundedRect(2,2,s-4,c-4,8),m.lineStyle(1,65484,.1),m.beginPath(),m.moveTo(8,c*.35),m.lineTo(s-8,c*.35),m.moveTo(8,c*.65),m.lineTo(s-8,c*.65),m.strokePath(),m.generateTexture(i,s,c),m.destroy()}function be(t,i,s){var c=t.make.graphics({x:0,y:0,add:!1});c.clear(),c.fillStyle(724758,1),c.fillCircle(s/2,s/2,s/2),c.lineStyle(2,65484,.55),c.strokeCircle(s/2,s/2,s/2-2),c.fillStyle(65484,.18),c.fillCircle(s/2,s/2,s/2-4),c.generateTexture(i,s,s),c.destroy()}function De(t){if(S){try{S.destroy(!0)}catch{}S=null}var i=430,s=820,c={type:Phaser.AUTO,parent:"game",width:i,height:s,backgroundColor:"#05070b",physics:{default:"arcade",arcade:{debug:!1,gravity:{y:0}}},scene:{preload:m,create:M,update:H}};const l={cfg:t,hp:t.frame.hp,hpMax:t.frame.hp,en:t.frame.en,enMax:t.frame.en,enRegen:t.frame.enRegen,speed:t.frame.speed,score:0,t0:0,lastA:0,lastB:0,target:null,lastSwitch:0,targetDist:0,lastDelta:0,dead:!1};function m(){j(this,"p",30,65484),j(this,"e",26,16731469),ge(this,"ba",10,65484),ge(this,"bb",10,16732120),be(this,"mn",22),he(this,"obA",140,90,2765892),he(this,"obB",220,130,2305082),he(this,"obC",110,180,2568772)}function M(){g("scene.create");var a=this;a.rangeTexts||(a.rangeTexts=[]),a.lockG||(a.lockG=a.add.graphics().setDepth(4)),a.radarG||(a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900),l.t0=a.time.now,a.physics.world.setBounds(-4e3,-4e3,8e3,8e3),a.player=a.physics.add.image(0,0,"p"),a.player.setDepth(2),a.player.setCircle(10),a.enemies=a.physics.add.group(),a.spawnAcc=0,a.spawnInterval=.85;function x(){var h=Math.random()*Math.PI*2,v=520+Math.random()*520,A=a.player.x+Math.cos(h)*v,D=a.player.y+Math.sin(h)*v,P=a.enemies.create(A,D,"e");return P.setData("hp",18),P.setData("blocked",!1),P.setRotation(Phaser.Math.Angle.Between(A,D,a.player.x,a.player.y)+Math.PI/2),P.setCollideWorldBounds(!1),P.setDepth(1),P}for(var e=0;e<6;e++)x();g("spawn init enemies="+a.enemies.getChildren().length),a.obsSpawnAcc=0,a.obsSpawnInterval=2.2,a.bullets=a.physics.add.group(),a.mines=a.physics.add.group(),a.obstacles=a.physics.add.staticGroup();for(var G=["obA","obB","obC"],o=0;o<25;o++){var T=Math.random()*Math.PI*2,n=280+Math.random()*1400,d=a.player.x+Math.cos(T)*n,r=a.player.y+Math.sin(T)*n,y=G[Math.random()*G.length|0],p=a.obstacles.create(d,r,y),k=p.body&&p.body.width?p.body.width:p.displayWidth||60,b=p.body&&p.body.height?p.body.height:p.displayHeight||60,L=Math.max(30,Math.floor(k*b/10));p.setData("maxHp",L),p.setData("hp",L),p.setAlpha(.55),p.setAlpha(.85),p.setRotation((Math.random()*2-1)*.18),p.setDepth(0),p.refreshBody()}a.obAcc=0,a.mechInfoText=a.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"16px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:5}).setScrollFactor(0).setDepth(12).setOrigin(0,1),a.barG=a.add.graphics().setScrollFactor(0).setDepth(10),a.rangeG=a.add.graphics().setDepth(0),a.lockG=a.add.graphics().setDepth(4),a.rangeTexts=[],a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900,a.cameras.main.startFollow(a.player,!0,.12,.12);var q=Math.max(l.cfg.wpnA.range||0,l.cfg.wpnB.range||0,520),W=$(680/q,.45,.9);a.cameras.main.setZoom(W),a.physics.add.overlap(a.bullets,a.enemies,function(h,v){if(!(!h.active||!v.active)){te(a,h.x,h.y,h.getData("pierce")?1:0);var A=h.getData("dmg")||6,D=v.getData("hp")||20;D-=A,v.setData("hp",D),h.destroy(),D<=0&&(v.destroy(),l.score+=1,l.kills=(l.kills||0)+1,V("kill",l.battleTimeMs||0,"KILL ("+(h.getData("weaponName")||"WEAPON")+")"))}}),a.physics.add.overlap(a.bullets,a.obstacles,function(h,v){if(!(!h.active||!v.active)){var A=h.getData("bornAt")||0;if(!(A&&a.time.now-A<60)){var D=h.getData("aoe")||0,P=h.getData("dmg")||10;if(D>0&&h.getData("explodeOnObstacle")){te(a,h.x,h.y,2);var Y=a.add.circle(h.x,h.y,D,16732120,.14);Y.setBlendMode(Phaser.BlendModes.ADD),a.time.delayedCall(180,function(){Y.active&&Y.destroy()})}else te(a,h.x,h.y,1);var E=v.getData("hp"),z=v.getData("maxHp")||60;typeof E!="number"&&(E=z),E-=P,v.setData("hp",E);var I=Math.max(0,E/z);if(v.setAlpha(.25+I*.45),v.setTint){var U=I<.5?9082293:7306918;I<.25&&(U=9132634),v.setTint(U)}E<=0&&(te(a,v.x,v.y,2),v.destroy(),V("obj",l.battleTimeMs||0,"OBJECT DESTROYED")),h.destroy()}}}),a.physics.add.collider(a.player,a.obstacles),a.physics.add.collider(a.enemies,a.obstacles),a.input.on("pointerdown",function(h){if(!l.dead){var v=Phaser.Math.Angle.Between(a.player.x,a.player.y,h.worldX,h.worldY);a.player.rotation=v+Math.PI/2,a.physics.velocityFromRotation(v,l.speed,a.player.body.velocity)}}),a.spawnAcc=0,a.dmgAcc=0,K("BATTLE STARTED"),g("Battle started")}function C(a){for(var x=a.enemies.getChildren(),e=0;e<2;e++){for(var G=null,o=1e18,T=0;T<x.length;T++){var n=x[T];if(n.active){var d=X(a,a.player.x,a.player.y,n.x,n.y);if(!(e===0&&d)){var r=n.x-a.player.x,y=n.y-a.player.y,p=r*r+y*y;p<o&&(o=p,G=n)}}}if(G)return G}return null}function O(a,x,e,G){if(!l.dead&&!(!l.target||!l.target.active)){var o=x,T=l.target,n=a.player.x,d=a.player.y,r=T.x,y=T.y,p=Phaser.Math.Distance.Between(n,d,r,y);if(!(o.range>0&&p>o.range)){if(o.type!=="melee"&&o.type!=="mine"){var k=X(a,n,d,r,y);if(k){var b=Z(a,n,d,r,y);if(b&&b.active)r=b.x,y=b.y,b.body&&(r=b.body.x+b.body.width*.5,y=b.body.y+b.body.height*.5),a._breakCoverAcc=(a._breakCoverAcc||0)+(l.lastDelta||0),a._breakCoverAcc>1200&&(a._breakCoverAcc=0,V("obj",l.battleTimeMs||0,"BREAK COVER → obstacle"));else return}}if(o.type==="melee"){var L=Math.PI*.65,q=Phaser.Math.Angle.Between(n,d,r,y);a.player.rotation=q+Math.PI/2,a.slashG||(a.slashG=a.add.graphics(),a.slashG.setDepth(2)),a.slashG.clear(),a.slashG.fillStyle(65484,.1),a.slashG.lineStyle(2,65484,.28),a.slashG.beginPath(),a.slashG.slice(n,d,o.range,q-L/2,q+L/2,!1),a.slashG.closePath(),a.slashG.fillPath(),a.slashG.strokePath(),a.time.delayedCall(90,function(){a.slashG&&a.slashG.clear()});for(var W=a.enemies.getChildren(),h=Math.max(10,Math.floor(o.dps*o.cd)),v=0;v<W.length;v++){var A=W[v];if(A.active){var D=A.x-n,P=A.y-d,Y=Math.sqrt(D*D+P*P);if(!(Y>o.range)){var E=Math.atan2(P,D),z=Phaser.Math.Angle.Wrap(E-q);Math.abs(z)<=L/2&&(A.setData("hp",(A.getData("hp")||20)-h),A.getData("hp")<=0&&(A.destroy(),l.score+=1))}}}return}if(o.type==="mine"){var I=a.physics.add.image(n,d,"mn");I.setDepth(1),I.setCircle(10),I.body.setImmovable(!0),I.body.setVelocity(0,0),I.setAlpha(.55),I.setData("armed",!1),I.setData("armAt",e+(o.armMs||240)),I.setData("radius",o.radius||120),I.setData("dmg",Math.max(12,Math.floor(o.dps*.9))),a.mines.add(I);return}var U=Phaser.Math.Angle.Between(n,d,r,y);a.player.rotation=U+Math.PI/2;var ye=Math.cos(U)*26,fe=Math.sin(U)*26,w=a.physics.add.image(n+ye,d+fe,G);w.setDepth(3),w.setCircle(4),w.setData("dmg",Math.max(6,Math.floor(o.dps*o.cd))),w.setData("bornAt",e),w.setData("pierce",!!o.pierce),w.setData("explodeOnObstacle",!!o.explodeOnObstacle),a.bullets.add(w),a.physics.velocityFromRotation(U,o.speed||1e3,w.body.velocity);var xe=Math.floor((o.range||900)/(o.speed||1e3)*1e3)+1200;a.time.delayedCall(xe,function(){w.active&&w.destroy()}),(o.type==="lob"||o.type==="missile")&&(w.setData("aoe",o.radius||90),w.setData("explodeOnObstacle",!!o.explodeOnObstacle))}}}function H(a,x){var e=this,G=l.startMs!=null?(e.time.now-l.startMs)/1e3:0;l.lastDelta=x;try{if(e._dbgAcc=(e._dbgAcc||0)+x,e._dbgAcc>700&&(e._dbgAcc=0,g("tick "+Math.floor(a))),l.dead)return;if(l.en=$(l.en+l.enRegen*(x/1e3),0,l.enMax),e.spawnAcc+=x/1e3,e.spawnAcc>=e.spawnInterval&&(e.spawnAcc=0,e.enemies.getChildren().length<26)){var o=Math.random()*Math.PI*2,T=560+Math.random()*660,n=e.player.x+Math.cos(o)*T,d=e.player.y+Math.sin(o)*T,r=e.enemies.create(n,d,"e");r.setData("hp",18),r.setData("blocked",!1),r.setRotation(Phaser.Math.Angle.Between(n,d,e.player.x,e.player.y)+Math.PI/2),r.setDepth(1)}e._cntAcc=(e._cntAcc||0)+x,e._cntAcc>2500&&(e._cntAcc=0,g("counts enemies="+e.enemies.getChildren().length+" obstacles="+(e.obstacles?e.obstacles.getChildren().length:0)+" bullets="+e.bullets.getChildren().length));for(var _=e.enemies&&e.enemies.getChildren?e.enemies.getChildren():[],y=0;y<_.length;y++){var r=_[y];if(!(!r.active||!r.body)){var p=Phaser.Math.Angle.Between(r.x,r.y,e.player.x,e.player.y),k=r.body.velocity.x,b=r.body.velocity.y,L=k*k+b*b,q=r.body.blocked&&(r.body.blocked.left||r.body.blocked.right||r.body.blocked.up||r.body.blocked.down)||r.body.touching&&(r.body.touching.left||r.body.touching.right||r.body.touching.up||r.body.touching.down)||L<40,W=r.getData("turnBias")||0,h=r.getData("turnBiasT")||0;(q||h<=0)&&(W=(Math.random()<.5?-1:1)*(.35+Math.random()*.35),h=220+Math.random()*260),h-=x,r.setData("turnBias",W),r.setData("turnBiasT",h);var v=p+(h>0?W:0),A=74,D=Phaser.Math.Distance.Between(r.x,r.y,e.player.x,e.player.y),P=A+(D<260?26:0);r.body.setVelocity(Math.cos(v)*P,Math.sin(v)*P),r.rotation=v+Math.PI/2}}var Pe=e.mines&&e.mines.getChildren?e.mines.getChildren():[],Y=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(e.obsSpawnAcc+=x/1e3,e.obsSpawnAcc>=e.obsSpawnInterval){e.obsSpawnAcc=0;var E=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(E.length<70){for(var z=0,I=0;I<E.length;I++){var U=E[I];U.active&&Phaser.Math.Distance.Between(U.x,U.y,e.player.x,e.player.y)<520&&z++}if(z<12){var o=Math.random()*Math.PI*2,T=360+Math.random()*560,n=e.player.x+Math.cos(o)*T,d=e.player.y+Math.sin(o)*T,ye=70+Math.random()*160,fe=50+Math.random()*150,w=e.obstacles.create(n,d,"ob");w.setImmovable(!0),w.body&&typeof w.body.setAllowGravity=="function"&&w.body.setAllowGravity(!1),w.body&&typeof w.body.setSize=="function"&&w.body.setSize(ye,fe,!0),w.displayWidth=ye,w.displayHeight=fe;var xe=Math.max(30,Math.floor(ye*fe/10));w.setData("maxHp",xe),w.setData("hp",xe),w.setAlpha(.55),typeof w.refreshBody=="function"&&w.refreshBody()}}}var u=l.target;if(u&&!u.active&&(u=null),!u)u=C(e),u&&(l.target=u,l.lastSwitch=a);else if(a-l.lastSwitch>=1e3){var re=C(e);if(re&&re!==u){var Je=Phaser.Math.Distance.Between(e.player.x,e.player.y,u.x,u.y),Qe=Phaser.Math.Distance.Between(e.player.x,e.player.y,re.x,re.y);Qe+40<Je&&(u=re,l.target=re,l.lastSwitch=a)}}l.targetDist=u&&u.active?Math.floor(Phaser.Math.Distance.Between(e.player.x,e.player.y,u.x,u.y)):0;for(var ke=0;ke<_.length;ke++){var ve=_[ke];if(ve.active){var le=X(e,e.player.x,e.player.y,ve.x,ve.y);ve.setAlpha(le?.18:1),ve.setData("blocked",le)}}if(e.lockG.clear(),u&&u.active){e.lockG.lineStyle(2,16722731,.55),e.lockG.beginPath(),e.lockG.moveTo(e.player.x,e.player.y),e.lockG.lineTo(u.x,u.y),e.lockG.strokePath(),e.lockG.fillStyle(16722731,.9);var Me=7;e.lockG.beginPath(),e.lockG.moveTo(u.x,u.y-Me),e.lockG.lineTo(u.x+Me,u.y),e.lockG.lineTo(u.x,u.y+Me),e.lockG.lineTo(u.x-Me,u.y),e.lockG.closePath(),e.lockG.fillPath()}for(var _=e.enemies.getChildren(),Ae=0;Ae<_.length;Ae++){var r=_[Ae];if(r.active){var Ne=Phaser.Math.Angle.Between(r.x,r.y,e.player.x,e.player.y),Ze=r.getData("spd")||180;e.physics.velocityFromRotation(Ne,Ze,r.body.velocity),r.rotation=Ne+Math.PI/2;var D=Phaser.Math.Distance.Between(r.x,r.y,e.player.x,e.player.y);D<22&&(l.hp-=.2*(x/16.666))}}for(var Pe=e.mines.getChildren(),Be=0;Be<Pe.length;Be++){var F=Pe[Be];if(F.active&&(!F.getData("armed")&&a>=(F.getData("armAt")||0)&&(F.setData("armed",!0),F.setAlpha(.95)),F.getData("armed")))for(var Re=F.getData("radius")||120,We=Re*Re,y=0;y<_.length;y++){var Ce=_[y];if(Ce.active){var ne=Ce.x-F.x,se=Ce.y-F.y;if(ne*ne+se*se<=We){for(var ze=F.getData("dmg")||18,Le=0;Le<_.length;Le++){var ee=_[Le];if(ee.active){var Ue=ee.x-F.x,qe=ee.y-F.y;Ue*Ue+qe*qe<=We&&(ee.setData("hp",(ee.getData("hp")||20)-ze),ee.getData("hp")<=0&&(ee.destroy(),l.score+=1))}}var Ie=e.add.circle(F.x,F.y,Re,65484,.18);Ie.setBlendMode(Phaser.BlendModes.ADD),e.time.delayedCall(180,function(){Ie.active&&Ie.destroy()}),F.destroy();break}}}}if(u&&u.active){var Ee=l.cfg.ai,$e=Ee.prefer,ea=Phaser.Math.Distance.Between(e.player.x,e.player.y,u.x,u.y),we=360;$e==="near"&&(we=220),$e==="mid"&&(we=380),$e==="far"&&(we=520);var aa=l.hp/l.hpMax<Ee.fleeHp,Fe=Phaser.Math.Angle.Between(e.player.x,e.player.y,u.x,u.y),ue=1;aa||ea<we*Ee.keep?ue=-1:ue=1,e.physics.velocityFromRotation(Fe,l.speed*.85*ue,e.player.body.velocity),e.player.rotation=ue===1?Fe+Math.PI/2:Fe-Math.PI/2}var ie=l.cfg.wpnA,oe=l.cfg.wpnB;a-l.lastA>=ie.cd*1e3&&(l.lastA=a,O(e,ie,a,"ba")),a-l.lastB>=oe.cd*1e3&&(l.lastB=a,O(e,oe,a,"bb")),e.rangeG.clear();for(var ta=Math.max(ie.range||0,oe.range||0,0),Ye=200,Ke=Math.max(1,Math.floor(ta/Ye));e.rangeTexts.length<Ke;){var Xe=e.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3});Xe.setDepth(9),e.rangeTexts.push(Xe)}for(var Oe=0;Oe<e.rangeTexts.length;Oe++)e.rangeTexts[Oe].setVisible(!1);for(var Te=1;Te<=Ke;Te++){var Se=Te*Ye;e.rangeG.lineStyle(1,16777215,.08),e.rangeG.strokeCircle(e.player.x,e.player.y,Se);var o=-Math.PI/4,ra=e.player.x+Math.cos(o)*Se,la=e.player.y+Math.sin(o)*Se,He=e.rangeTexts[Te-1];He.setText(String(Se)),He.setPosition(ra+6,la-10),He.setVisible(!0)}if(ie.range&&ie.range>0&&(e.rangeG.lineStyle(2,65484,.2),e.rangeG.strokeCircle(e.player.x,e.player.y,ie.range)),oe.range&&oe.range>0&&(e.rangeG.lineStyle(2,16732120,.18),e.rangeG.strokeCircle(e.player.x,e.player.y,oe.range)),e.radarG){e.radarG.clear();var de=e.radarX,ce=e.radarY,pe=e.radarR;e.radarG.fillStyle(0,.35),e.radarG.fillCircle(de,ce,pe+8),e.radarG.lineStyle(2,65484,.22),e.radarG.strokeCircle(de,ce,pe),e.radarG.lineStyle(1,16777215,.08),e.radarG.strokeCircle(de,ce,pe*.66),e.radarG.strokeCircle(de,ce,pe*.33),e.radarG.fillStyle(65484,.9),e.radarG.fillCircle(de,ce,3);for(var Ve=e.radarRange,_e=0;_e<_.length;_e++){var r=_[_e];if(r.active){var ne=r.x-e.player.x,se=r.y-e.player.y,T=Math.sqrt(ne*ne+se*se);if(!(T>Ve)){var na=de+ne/Ve*pe,sa=ce+se/Ve*pe,le=!!r.getData("blocked");e.radarG.fillStyle(le?16732120:16722731,le?.7:.85),e.radarG.fillCircle(na,sa,le?2:2.5)}}}}var ia=200;e.scorePanelG=e.add.graphics().setScrollFactor(0),e.scoreLabelText=e.add.text(0,0,"SCORE",{fontFamily:"system-ui, sans-serif",fontSize:"12px",fontStyle:"700",fill:"#b8c6ff",stroke:"#000",strokeThickness:3}).setScrollFactor(0),e.scoreValueText=e.add.text(0,0,"0",{fontFamily:"system-ui, sans-serif",fontSize:"22px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:4}).setScrollFactor(0),e.waveTimeText=e.add.text(0,0,"W1  00:00",{fontFamily:"system-ui, sans-serif",fontSize:"14px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0),e.hpText=e.add.text(0,0,"HP 0/0",{fontFamily:"system-ui, sans-serif",fontSize:"18px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0),e.expText=e.add.text(0,0,"EXP 0",{fontFamily:"system-ui, sans-serif",fontSize:"14px",fontStyle:"700",fill:"#ffd36b",stroke:"#000",strokeThickness:3}).setScrollFactor(0),e.hpBarG=e.add.graphics().setScrollFactor(0),e.expBarG=e.add.graphics().setScrollFactor(0),e.hpGroup=e.add.container(0,0,[e.hpText,e.expText,e.hpBarG,e.expBarG]),e.weaponMainText=e.add.text(0,0,"MAIN",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0),e.weaponSubText=e.add.text(0,0,"SUB",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0),e.weaponG=e.add.graphics().setScrollFactor(0),e.weaponGroup=e.add.container(0,0,[e.weaponG,e.weaponMainText,e.weaponSubText]),e.uiLayer=e.add.container(0,0,[e.scorePanelG,e.scoreLabelText,e.scoreValueText,e.waveTimeText,e.hpGroup,e.weaponGroup]).setScrollFactor(0).setDepth(ia),e.hpGroup.setScrollFactor(0),e.weaponGroup.setScrollFactor(0),Q(e,l,G),l.hp<=0&&(l.dead=!0,l.hp=0,me(l.score,Math.floor(G||0),l.cfg))}catch(ae){g("EXCEPTION: "+(ae&&ae.message?ae.message:ae)+(ae&&ae.stack?`
`+ae.stack:"")),l.dead=!0}}S=new Phaser.Game(c)}function me(t,i,s){try{S&&S.scene.pause()}catch{}R.showResult(t,i,s)}return g("bootGame called"),De(f),{destroy:()=>{try{S&&(S.destroy(!0),S=null)}catch{}}}},B=f=>{const R=document.getElementById(f);if(!R)throw new Error(`Missing required element: ${f}`);return R},pa=f=>{let S=Math.max(0,f|0);const g=Math.floor(S/36e5);S-=g*36e5;const K=Math.floor(S/6e4);S-=K*6e4;const V=Math.floor(S/1e3),$=S-V*1e3;return`${String(g).padStart(2,"0")}:${String(K).padStart(2,"0")}:${String(V).padStart(2,"0")}.${String($).padStart(3,"0")}`},ha=f=>f.replace(/[&<>"]/g,R=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[R]??R),ya=f=>{const R=B("debugBtn"),S=B("debugPanel"),g=B("mechLogPanel"),K=B("mechLogLines"),V=B("startPanel"),$=B("resultPanel"),te=B("toast"),Q=B("selFrame"),X=B("selWpnA"),Z=B("selWpnB"),j=B("selAI"),ge=B("frameDesc"),he=B("wpnADesc"),be=B("wpnBDesc"),De=B("aiDesc"),me=B("kpi"),t=B("resultText"),i=B("resultKpi"),s=B("btnStart"),c=B("btnRetry");let l=!1;const m=[],M=[],C=window.location.hostname==="localhost"||window.location.search.includes("debug=1");document.body.classList.toggle("is-debug",C),R.style.display=C?"block":"none";const O=()=>{const d=M.map((r,y)=>{const p=y===M.length-1?"is-latest":"is-old";return`<div class='line ${r.cls} ${p}'>${pa(r.t)} ${ha(r.msg)}</div>`});for(;d.length<5;)d.push("<div class='line placeholder'>&nbsp;</div>");K.innerHTML=d.join("")};g.style.display="none",g.style.visibility="hidden",O();const H=n=>{const d=new Date().toISOString().slice(11,19);m.push(`[${d}] ${n}`),m.length>200&&m.shift(),S.textContent=m.join(`
`)},a=n=>{te.textContent=String(n)},x=(n,d,r)=>{g.style.display="block",g.style.visibility="visible";const y=`c-${n??"sys"}`;M.push({t:d|0,cls:y,msg:r}),M.length>5&&M.shift(),O(),g.style.opacity="0",requestAnimationFrame(()=>{g.style.opacity="0.8"}),window.clearTimeout(g.__fadeTimer),g.__fadeTimer=window.setTimeout(()=>{g.style.opacity="0.35"},2500)},e=(n,d)=>{n.innerHTML="",d.forEach(r=>{const y=document.createElement("option");y.value=r.id,y.textContent=r.name??r.id,n.appendChild(y)})},G=()=>{const n=f.frames.find(k=>k.id===Q.value),d=f.weapons.find(k=>k.id===X.value),r=f.weapons.find(k=>k.id===Z.value),y=f.ai.find(k=>k.id===j.value);if(!n||!d||!r||!y)return;ge.textContent=`${n.desc}  (HP ${n.hp} / SPD ${n.speed})`,he.textContent=`${d.desc}  (R ${d.range} / DPS ${d.dps})`,be.textContent=`${r.desc}  (R ${r.range} / DPS ${r.dps})`,De.textContent=y.desc,me.innerHTML="";const p=(k,b)=>{const L=document.createElement("div");L.className=`pill ${b??""}`.trim(),L.textContent=k,me.appendChild(L)};p(`FRAME: ${n.name}`,"good"),p(`MAIN: ${d.name}`),p(`SUB: ${r.name}`),p(`AI: ${y.name}`)};return e(Q,f.frames),e(X,f.weapons),e(Z,f.weapons),e(j,f.ai),Q.value="middle",X.value="mg",Z.value="cannon",j.value="balanced",Q.addEventListener("change",G),X.addEventListener("change",G),Z.addEventListener("change",G),j.addEventListener("change",G),G(),V.classList.remove("hidden"),V.style.display="flex",$.classList.add("hidden"),$.style.display="none",g.style.display="none",g.style.visibility="hidden",C&&R.addEventListener("click",()=>{l=!l,S.style.display=l?"block":"none"}),window.addEventListener("error",n=>{var r;const d=n!=null&&n.message?n.message:String(n);H(`ERROR: ${d}${(r=n==null?void 0:n.error)!=null&&r.stack?`
${n.error.stack}`:""}`),a(`ERROR: ${d}`)}),{onStart:n=>s.addEventListener("click",n),onRetry:n=>c.addEventListener("click",n),hideStart:()=>{V.classList.add("hidden"),V.style.display="none",g.style.display="block",g.style.visibility="visible"},showStart:()=>{V.classList.remove("hidden"),V.style.display="flex",$.classList.add("hidden"),$.style.display="none",g.style.display="none",g.style.visibility="hidden"},hideResult:()=>{$.classList.add("hidden"),$.style.display="none"},showResultPanel:()=>{$.classList.remove("hidden"),$.style.display="flex",g.style.display="none",g.style.visibility="hidden"},getConfig:()=>({frameId:Q.value,wpnAId:X.value,wpnBId:Z.value,aiId:j.value}),setToast:a,setDebug:H,pushMechLog:x,renderResult:(n,d,r)=>{const y=`SCORE: ${n}
TIME: ${d}s
FRAME: ${r.frame.name} / AI: ${r.ai.name}
MAIN: ${r.wpnA.name} / SUB: ${r.wpnB.name}`;t.textContent=y,i.innerHTML="";const p=(k,b)=>{const L=document.createElement("div");L.className=`pill ${b??""}`.trim(),L.textContent=k,i.appendChild(L)};p(`SCORE ${n}`,"good"),p(`TIME ${d}s`),p(r.frame.name),p(r.ai.name),p(`MAIN ${r.wpnA.name}`),p(`SUB ${r.wpnB.name}`,"bad")}}},N=ya(Ge),fa=f=>{const R=oa[f.frameId],S=je[f.wpnAId],g=je[f.wpnBId],K=da[f.aiId];if(!R||!S||!g||!K)throw new Error("Invalid loadout selection.");return{frame:R,wpnA:S,wpnB:g,ai:K}};let J=null;const va={toast:N.setToast,debug:N.setDebug,mechLog:N.pushMechLog,showResult:(f,R,S)=>{N.renderResult(f,R,S),N.showResultPanel()}};N.onStart(()=>{N.hideResult(),N.hideStart();const f=fa(N.getConfig());J==null||J.destroy(),J=ca(f,va)});N.onRetry(()=>{N.hideResult(),N.showStart(),J==null||J.destroy(),J=null,N.setToast("READY")});
