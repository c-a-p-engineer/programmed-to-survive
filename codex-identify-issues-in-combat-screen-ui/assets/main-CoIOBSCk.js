import"./modulepreload-polyfill-B5Qt9EMX.js";const Te={frames:[{id:"light",name:"LIGHT",hp:70,speed:240,en:100,enRegen:18,desc:"高速。薄い。回避で生きる。"},{id:"middle",name:"MIDDLE",hp:95,speed:210,en:120,enRegen:14,desc:"標準。バランス。"},{id:"heavy",name:"HEAVY",hp:130,speed:175,en:140,enRegen:11,desc:"鈍い。硬い。詰みづらい。"}],weapons:[{id:"mg",name:"Machinegun",type:"bullet",range:900,dps:14,cd:.1,speed:1e3,desc:"連射。見てて気持ちいい。",pierce:!1,explodeOnObstacle:!1},{id:"cannon",name:"Cannon",type:"bullet",range:1250,dps:22,cd:.55,speed:1250,desc:"高威力。遠距離。",pierce:!1,explodeOnObstacle:!1},{id:"missile",name:"Missile",type:"missile",range:1050,dps:18,cd:.7,speed:800,radius:110,desc:"範囲。雑に強い。",pierce:!1,explodeOnObstacle:!0},{id:"grenade",name:"Grenade",type:"lob",range:520,dps:16,cd:.85,speed:620,radius:85,desc:"近〜中。範囲。",pierce:!1,explodeOnObstacle:!0},{id:"blade",name:"Blade",type:"melee",range:120,dps:22,cd:.45,speed:0,desc:"近接。扇型。"},{id:"mine",name:"Mine",type:"mine",range:0,dps:22,cd:1.1,speed:0,radius:120,armMs:240,desc:"設置。踏ませる。"}],ai:[{id:"balanced",name:"Balanced",keep:.75,fleeHp:.18,prefer:"mid",desc:"無難。死ににくい。"},{id:"sniper",name:"Sniper",keep:.95,fleeHp:.12,prefer:"far",desc:"距離を取る。"},{id:"berserker",name:"Berserker",keep:.35,fleeHp:.08,prefer:"near",desc:"突っ込む。死にやすい。"},{id:"coward",name:"Coward",keep:.98,fleeHp:.35,prefer:"far",desc:"逃げる。稼げない。"},{id:"hunter",name:"Hunter",keep:.65,fleeHp:.1,prefer:"mid",desc:"近い敵を確実に。"}]},Xe=Object.fromEntries(Te.weapons.map(v=>[v.id,v])),oa=Object.fromEntries(Te.frames.map(v=>[v.id,v])),ia=Object.fromEntries(Te.ai.map(v=>[v.id,v])),ca=(v,P)=>{let S=null;const E=P.debug,K=P.toast,Y=P.mechLog;function j(t,o,s){return t<o?o:t>s?s:t}function ne(t,o,s,p){var r=p===1?10:p===2?18:6,x=p===2?16732120:16777215,M=t.add.circle(o,s,r,x,p===2?.18:.22);M.setBlendMode(Phaser.BlendModes.ADD),M.setDepth(5),t.tweens.add({targets:M,alpha:0,duration:160,onComplete:function(){M.active&&M.destroy()}})}function ee(t,o,s){var p=t.cameras.main,r=p.width,x=p.height,M=4,C=0,H=56,B=118,a=x-B;t.topPanelG&&(t.topPanelG.clear(),t.topPanelG.fillStyle(0,.62),t.topPanelG.fillRoundedRect(2,C,r-4,H,14),t.topPanelG.lineStyle(2,65484,.18),t.topPanelG.strokeRoundedRect(2,C,r-4,H,14));var g=Math.floor((s||0)*1e3),e=Math.floor(s||0),A=String(Math.floor(e/60)).padStart(2,"0"),d=String(e%60).padStart(2,"0");if(t.scoreText&&(t.scoreText.setText("SCORE "+String(o.score|0)),t.scoreText.setPosition(0,0)),t.waveTimeText&&(t.waveTimeText.setText("WAVE "+String(o.wave||1)+"   TIME "+A+":"+d),t.waveTimeText.setPosition(M+4,C+10)),t.bottomPanelG&&(t.bottomPanelG.clear(),t.bottomPanelG.fillStyle(0,.55),t.bottomPanelG.fillRoundedRect(2,a,r-4,B,14),t.bottomPanelG.lineStyle(1,65484,.14),t.bottomPanelG.strokeRoundedRect(2,a,r-4,B,14)),t.mechInfoText){var l=o.cfg.wpnA?o.cfg.wpnA.name:"A",i=o.cfg.wpnB?o.cfg.wpnB.name:"B",c=o.cfg.frame?o.cfg.frame.name:"-",n=o.cfg.ai?o.cfg.ai.name:"-";t.mechInfoText.setText("FRAME "+c+"   AI "+n+"   MAIN "+l+"   SUB "+i),t.mechInfoText.setPosition(M+4,a+B-10)}if(t.hpText){var f=Math.max(0,o.hp|0),h=Math.max(1,o.hpMax??o.maxHp??1);t.hpText.setText("HP "+f+"/"+h),t.hpText.setPosition(M+4,a+12)}if(t.expText){var I=Math.max(0,(o.exp??o.score??0)|0);t.expText.setText("EXP "+I),t.expText.setPosition(M+4,a+36)}if(t.barG){t.barG.clear();var w=M+4,L=a+62,_=r-M*2-8,N=10,y=j(o.hp/(o.hpMax||1),0,1);t.barG.fillStyle(16777215,.12),t.barG.fillRoundedRect(w,L,_,N,6),t.barG.fillStyle(65484,.6),t.barG.fillRoundedRect(w,L,Math.max(4,_*y),N,6);var u=j(o.en/(o.enMax||1),0,1);t.barG.fillStyle(16777215,.1),t.barG.fillRoundedRect(w,L+14,_,N,6),t.barG.fillStyle(6728447,.6),t.barG.fillRoundedRect(w,L+14,Math.max(4,_*u),N,6)}if(t.weaponMainText){var b=o.cfg.wpnA?o.cfg.wpnA.name:"A";t.weaponMainText.setText("MAIN "+b),t.weaponMainText.setPosition(M+34,a+82)}if(t.weaponSubText){var k=o.cfg.wpnB?o.cfg.wpnB.name:"B";t.weaponSubText.setText("SUB "+k),t.weaponSubText.setPosition(M+34,a+100)}if(t.weaponG){t.weaponG.clear();var R=M+4,U=18;t.weaponG.fillStyle(65484,.85),t.weaponG.fillRoundedRect(R,a+80,U,U,4),t.weaponG.fillStyle(6728447,.85),t.weaponG.fillRoundedRect(R,a+98,U,U,4)}if(t.scorePanelG&&t.scoreText){var $=8,q=t.scoreText.width+$*2,T=t.scoreText.height+10,O=r-q-2,J=C+2;t.scorePanelG.clear(),t.scorePanelG.fillStyle(0,.62),t.scorePanelG.fillRoundedRect(O,J,q,T,12),t.scorePanelG.lineStyle(2,65484,.2),t.scorePanelG.strokeRoundedRect(O,J,q,T,12),t.scoreText.setPosition(O+$,J+4)}if(t.radarG){var Z=Math.round(Math.min(60,Math.max(44,r*.16)));t.radarR=Z,t.radarX=r-Z-16,t.radarY=a-Z-14}o.battleTimeMs=g}function X(t,o,s,p,r){if(!t.obstacles)return!1;var x=new Phaser.Geom.Line(o,s,p,r),M=t.obstacles.getChildren(),C=p-o,H=r-s,B=Math.sqrt(C*C+H*H);if(B<1)return!1;for(var a=0;a<M.length;a++){var g=M[a];if(g.active){var e=g.body;if(e){var A=e.x+e.width*.5,d=e.y+e.height*.5,l=A-o,i=d-s,c=Math.sqrt(l*l+i*i);if(!(c<34)&&!(c>B-10)){var n=new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height);if(Phaser.Geom.Intersects.LineToRectangle(x,n))return!0}}}}return!1}function ae(t,o,s,p,r){if(!t.obstacles)return null;for(var x=new Phaser.Geom.Line(o,s,p,r),M=t.obstacles.getChildren(),C=null,H=1e9,B=0;B<M.length;B++){var a=M[B];if(!(!a.active||!a.body)){var g=a.body,e=new Phaser.Geom.Rectangle(g.x,g.y,g.width,g.height);if(Phaser.Geom.Intersects.LineToRectangle(x,e)){var A=g.x+g.width*.5,d=g.y+g.height*.5,l=Phaser.Math.Distance.Between(o,s,A,d);l<H&&(H=l,C=a)}}}return C}function Q(t,o,s,p){var r=t.make.graphics({x:0,y:0,add:!1});r.clear(),r.fillStyle(p,1),r.fillTriangle(s/2,1,1,s-1,s-1,s-1),r.generateTexture(o,s,s),r.destroy()}function me(t,o,s,p){var r=t.make.graphics({x:0,y:0,add:!1});r.clear(),r.fillStyle(0,.35),r.fillCircle(s/2+1,s/2+1,s/2),r.fillStyle(p,1),r.fillCircle(s/2,s/2,s/2-1),r.generateTexture(o,s,s),r.destroy()}function ye(t,o,s,p,r){var x=t.make.graphics({x:0,y:0,add:!1});x.clear(),x.fillStyle(r,1),x.fillRoundedRect(0,0,s,p,10),x.lineStyle(2,16777215,.12),x.strokeRoundedRect(2,2,s-4,p-4,8),x.lineStyle(1,65484,.1),x.beginPath(),x.moveTo(8,p*.35),x.lineTo(s-8,p*.35),x.moveTo(8,p*.65),x.lineTo(s-8,p*.65),x.strokePath(),x.generateTexture(o,s,p),x.destroy()}function Ge(t,o,s){var p=t.make.graphics({x:0,y:0,add:!1});p.clear(),p.fillStyle(724758,1),p.fillCircle(s/2,s/2,s/2),p.lineStyle(2,65484,.55),p.strokeCircle(s/2,s/2,s/2-2),p.fillStyle(65484,.18),p.fillCircle(s/2,s/2,s/2-4),p.generateTexture(o,s,s),p.destroy()}function Pe(t){if(S){try{S.destroy(!0)}catch{}S=null}var o=430,s=820,p={type:Phaser.AUTO,parent:"game",width:o,height:s,backgroundColor:"#05070b",physics:{default:"arcade",arcade:{debug:!1,gravity:{y:0}}},scene:{preload:x,create:M,update:B}};const r={cfg:t,hp:t.frame.hp,hpMax:t.frame.hp,en:t.frame.en,enMax:t.frame.en,enRegen:t.frame.enRegen,speed:t.frame.speed,score:0,t0:0,lastA:0,lastB:0,target:null,lastSwitch:0,targetDist:0,lastDelta:0,dead:!1};function x(){Q(this,"p",30,65484),Q(this,"e",26,16731469),me(this,"ba",10,65484),me(this,"bb",10,16732120),Ge(this,"mn",22),ye(this,"obA",140,90,2765892),ye(this,"obB",220,130,2305082),ye(this,"obC",110,180,2568772)}function M(){E("scene.create");var a=this;a.rangeTexts||(a.rangeTexts=[]),a.lockG||(a.lockG=a.add.graphics().setDepth(4)),a.radarG||(a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900),r.t0=a.time.now,a.physics.world.setBounds(-4e3,-4e3,8e3,8e3),a.player=a.physics.add.image(0,0,"p"),a.player.setDepth(2),a.player.setCircle(10),a.enemies=a.physics.add.group(),a.spawnAcc=0,a.spawnInterval=.85;function g(){var y=Math.random()*Math.PI*2,u=520+Math.random()*520,b=a.player.x+Math.cos(y)*u,k=a.player.y+Math.sin(y)*u,R=a.enemies.create(b,k,"e");return R.setData("hp",18),R.setData("blocked",!1),R.setRotation(Phaser.Math.Angle.Between(b,k,a.player.x,a.player.y)+Math.PI/2),R.setCollideWorldBounds(!1),R.setDepth(1),R}for(var e=0;e<6;e++)g();E("spawn init enemies="+a.enemies.getChildren().length),a.obsSpawnAcc=0,a.obsSpawnInterval=2.2,a.bullets=a.physics.add.group(),a.mines=a.physics.add.group(),a.obstacles=a.physics.add.staticGroup();for(var A=["obA","obB","obC"],d=0;d<25;d++){var l=Math.random()*Math.PI*2,i=280+Math.random()*1400,c=a.player.x+Math.cos(l)*i,n=a.player.y+Math.sin(l)*i,f=A[Math.random()*A.length|0],h=a.obstacles.create(c,n,f),I=h.body&&h.body.width?h.body.width:h.displayWidth||60,w=h.body&&h.body.height?h.body.height:h.displayHeight||60,L=Math.max(30,Math.floor(I*w/10));h.setData("maxHp",L),h.setData("hp",L),h.setAlpha(.55),h.setAlpha(.85),h.setRotation((Math.random()*2-1)*.18),h.setDepth(0),h.refreshBody()}a.obAcc=0,a.topPanelG=a.add.graphics().setScrollFactor(0).setDepth(11),a.bottomPanelG=a.add.graphics().setScrollFactor(0).setDepth(11),a.mechInfoText=a.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"16px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:5}).setScrollFactor(0).setDepth(12).setOrigin(0,1),a.barG=a.add.graphics().setScrollFactor(0).setDepth(10),a.rangeG=a.add.graphics().setDepth(0),a.lockG=a.add.graphics().setDepth(4),a.rangeTexts=[],a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900,a.cameras.main.startFollow(a.player,!0,.12,.12);var _=Math.max(r.cfg.wpnA.range||0,r.cfg.wpnB.range||0,520),N=j(680/_,.45,.9);a.cameras.main.setZoom(N),a.physics.add.overlap(a.bullets,a.enemies,function(y,u){if(!(!y.active||!u.active)){ne(a,y.x,y.y,y.getData("pierce")?1:0);var b=y.getData("dmg")||6,k=u.getData("hp")||20;k-=b,u.setData("hp",k),y.destroy(),k<=0&&(u.destroy(),r.score+=1,r.kills=(r.kills||0)+1,Y("kill",r.battleTimeMs||0,"KILL ("+(y.getData("weaponName")||"WEAPON")+")"))}}),a.physics.add.overlap(a.bullets,a.obstacles,function(y,u){if(!(!y.active||!u.active)){var b=y.getData("bornAt")||0;if(!(b&&a.time.now-b<60)){var k=y.getData("aoe")||0,R=y.getData("dmg")||10;if(k>0&&y.getData("explodeOnObstacle")){ne(a,y.x,y.y,2);var U=a.add.circle(y.x,y.y,k,16732120,.14);U.setBlendMode(Phaser.BlendModes.ADD),a.time.delayedCall(180,function(){U.active&&U.destroy()})}else ne(a,y.x,y.y,1);var $=u.getData("hp"),q=u.getData("maxHp")||60;typeof $!="number"&&($=q),$-=R,u.setData("hp",$);var T=Math.max(0,$/q);if(u.setAlpha(.25+T*.45),u.setTint){var O=T<.5?9082293:7306918;T<.25&&(O=9132634),u.setTint(O)}$<=0&&(ne(a,u.x,u.y,2),u.destroy(),Y("obj",r.battleTimeMs||0,"OBJECT DESTROYED")),y.destroy()}}}),a.physics.add.collider(a.player,a.obstacles),a.physics.add.collider(a.enemies,a.obstacles),a.input.on("pointerdown",function(y){if(!r.dead){var u=Phaser.Math.Angle.Between(a.player.x,a.player.y,y.worldX,y.worldY);a.player.rotation=u+Math.PI/2,a.physics.velocityFromRotation(u,r.speed,a.player.body.velocity)}}),a.spawnAcc=0,a.dmgAcc=0,K("BATTLE STARTED"),E("Battle started")}function C(a){for(var g=a.enemies.getChildren(),e=0;e<2;e++){for(var A=null,d=1e18,l=0;l<g.length;l++){var i=g[l];if(i.active){var c=X(a,a.player.x,a.player.y,i.x,i.y);if(!(e===0&&c)){var n=i.x-a.player.x,f=i.y-a.player.y,h=n*n+f*f;h<d&&(d=h,A=i)}}}if(A)return A}return null}function H(a,g,e,A){if(!r.dead&&!(!r.target||!r.target.active)){var d=g,l=r.target,i=a.player.x,c=a.player.y,n=l.x,f=l.y,h=Phaser.Math.Distance.Between(i,c,n,f);if(!(d.range>0&&h>d.range)){if(d.type!=="melee"&&d.type!=="mine"){var I=X(a,i,c,n,f);if(I){var w=ae(a,i,c,n,f);if(w&&w.active)n=w.x,f=w.y,w.body&&(n=w.body.x+w.body.width*.5,f=w.body.y+w.body.height*.5),a._breakCoverAcc=(a._breakCoverAcc||0)+(r.lastDelta||0),a._breakCoverAcc>1200&&(a._breakCoverAcc=0,Y("obj",r.battleTimeMs||0,"BREAK COVER → obstacle"));else return}}if(d.type==="melee"){var L=Math.PI*.65,_=Phaser.Math.Angle.Between(i,c,n,f);a.player.rotation=_+Math.PI/2,a.slashG||(a.slashG=a.add.graphics(),a.slashG.setDepth(2)),a.slashG.clear(),a.slashG.fillStyle(65484,.1),a.slashG.lineStyle(2,65484,.28),a.slashG.beginPath(),a.slashG.slice(i,c,d.range,_-L/2,_+L/2,!1),a.slashG.closePath(),a.slashG.fillPath(),a.slashG.strokePath(),a.time.delayedCall(90,function(){a.slashG&&a.slashG.clear()});for(var N=a.enemies.getChildren(),y=Math.max(10,Math.floor(d.dps*d.cd)),u=0;u<N.length;u++){var b=N[u];if(b.active){var k=b.x-i,R=b.y-c,U=Math.sqrt(k*k+R*R);if(!(U>d.range)){var $=Math.atan2(R,k),q=Phaser.Math.Angle.Wrap($-_);Math.abs(q)<=L/2&&(b.setData("hp",(b.getData("hp")||20)-y),b.getData("hp")<=0&&(b.destroy(),r.score+=1))}}}return}if(d.type==="mine"){var T=a.physics.add.image(i,c,"mn");T.setDepth(1),T.setCircle(10),T.body.setImmovable(!0),T.body.setVelocity(0,0),T.setAlpha(.55),T.setData("armed",!1),T.setData("armAt",e+(d.armMs||240)),T.setData("radius",d.radius||120),T.setData("dmg",Math.max(12,Math.floor(d.dps*.9))),a.mines.add(T);return}var O=Phaser.Math.Angle.Between(i,c,n,f);a.player.rotation=O+Math.PI/2;var J=Math.cos(O)*26,Z=Math.sin(O)*26,D=a.physics.add.image(i+J,c+Z,A);D.setDepth(3),D.setCircle(4),D.setData("dmg",Math.max(6,Math.floor(d.dps*d.cd))),D.setData("bornAt",e),D.setData("pierce",!!d.pierce),D.setData("explodeOnObstacle",!!d.explodeOnObstacle),a.bullets.add(D),a.physics.velocityFromRotation(O,d.speed||1e3,D.body.velocity);var xe=Math.floor((d.range||900)/(d.speed||1e3)*1e3)+1200;a.time.delayedCall(xe,function(){D.active&&D.destroy()}),(d.type==="lob"||d.type==="missile")&&(D.setData("aoe",d.radius||90),D.setData("explodeOnObstacle",!!d.explodeOnObstacle))}}}function B(a,g){var e=this,A=r.startMs!=null?(e.time.now-r.startMs)/1e3:0;r.lastDelta=g;try{if(e._dbgAcc=(e._dbgAcc||0)+g,e._dbgAcc>700&&(e._dbgAcc=0,E("tick "+Math.floor(a))),r.dead)return;if(r.en=j(r.en+r.enRegen*(g/1e3),0,r.enMax),e.spawnAcc+=g/1e3,e.spawnAcc>=e.spawnInterval&&(e.spawnAcc=0,e.enemies.getChildren().length<26)){var d=Math.random()*Math.PI*2,l=560+Math.random()*660,i=e.player.x+Math.cos(d)*l,c=e.player.y+Math.sin(d)*l,n=e.enemies.create(i,c,"e");n.setData("hp",18),n.setData("blocked",!1),n.setRotation(Phaser.Math.Angle.Between(i,c,e.player.x,e.player.y)+Math.PI/2),n.setDepth(1)}e._cntAcc=(e._cntAcc||0)+g,e._cntAcc>2500&&(e._cntAcc=0,E("counts enemies="+e.enemies.getChildren().length+" obstacles="+(e.obstacles?e.obstacles.getChildren().length:0)+" bullets="+e.bullets.getChildren().length));for(var W=e.enemies&&e.enemies.getChildren?e.enemies.getChildren():[],f=0;f<W.length;f++){var n=W[f];if(!(!n.active||!n.body)){var h=Phaser.Math.Angle.Between(n.x,n.y,e.player.x,e.player.y),I=n.body.velocity.x,w=n.body.velocity.y,L=I*I+w*w,_=n.body.blocked&&(n.body.blocked.left||n.body.blocked.right||n.body.blocked.up||n.body.blocked.down)||n.body.touching&&(n.body.touching.left||n.body.touching.right||n.body.touching.up||n.body.touching.down)||L<40,N=n.getData("turnBias")||0,y=n.getData("turnBiasT")||0;(_||y<=0)&&(N=(Math.random()<.5?-1:1)*(.35+Math.random()*.35),y=220+Math.random()*260),y-=g,n.setData("turnBias",N),n.setData("turnBiasT",y);var u=h+(y>0?N:0),b=74,k=Phaser.Math.Distance.Between(n.x,n.y,e.player.x,e.player.y),R=b+(k<260?26:0);n.body.setVelocity(Math.cos(u)*R,Math.sin(u)*R),n.rotation=u+Math.PI/2}}var Ae=e.mines&&e.mines.getChildren?e.mines.getChildren():[],U=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(e.obsSpawnAcc+=g/1e3,e.obsSpawnAcc>=e.obsSpawnInterval){e.obsSpawnAcc=0;var $=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if($.length<70){for(var q=0,T=0;T<$.length;T++){var O=$[T];O.active&&Phaser.Math.Distance.Between(O.x,O.y,e.player.x,e.player.y)<520&&q++}if(q<12){var d=Math.random()*Math.PI*2,l=360+Math.random()*560,i=e.player.x+Math.cos(d)*l,c=e.player.y+Math.sin(d)*l,J=70+Math.random()*160,Z=50+Math.random()*150,D=e.obstacles.create(i,c,"ob");D.setImmovable(!0),D.body&&typeof D.body.setAllowGravity=="function"&&D.body.setAllowGravity(!1),D.body&&typeof D.body.setSize=="function"&&D.body.setSize(J,Z,!0),D.displayWidth=J,D.displayHeight=Z;var xe=Math.max(30,Math.floor(J*Z/10));D.setData("maxHp",xe),D.setData("hp",xe),D.setAlpha(.55),typeof D.refreshBody=="function"&&D.refreshBody()}}}var m=r.target;if(m&&!m.active&&(m=null),!m)m=C(e),m&&(r.target=m,r.lastSwitch=a);else if(a-r.lastSwitch>=1e3){var le=C(e);if(le&&le!==m){var Je=Phaser.Math.Distance.Between(e.player.x,e.player.y,m.x,m.y),Ze=Phaser.Math.Distance.Between(e.player.x,e.player.y,le.x,le.y);Ze+40<Je&&(m=le,r.target=le,r.lastSwitch=a)}}r.targetDist=m&&m.active?Math.floor(Phaser.Math.Distance.Between(e.player.x,e.player.y,m.x,m.y)):0;for(var be=0;be<W.length;be++){var ve=W[be];if(ve.active){var se=X(e,e.player.x,e.player.y,ve.x,ve.y);ve.setAlpha(se?.18:1),ve.setData("blocked",se)}}if(e.lockG.clear(),m&&m.active){e.lockG.lineStyle(2,16722731,.55),e.lockG.beginPath(),e.lockG.moveTo(e.player.x,e.player.y),e.lockG.lineTo(m.x,m.y),e.lockG.strokePath(),e.lockG.fillStyle(16722731,.9);var Me=7;e.lockG.beginPath(),e.lockG.moveTo(m.x,m.y-Me),e.lockG.lineTo(m.x+Me,m.y),e.lockG.lineTo(m.x,m.y+Me),e.lockG.lineTo(m.x-Me,m.y),e.lockG.closePath(),e.lockG.fillPath()}for(var W=e.enemies.getChildren(),ke=0;ke<W.length;ke++){var n=W[ke];if(n.active){var We=Phaser.Math.Angle.Between(n.x,n.y,e.player.x,e.player.y),Qe=n.getData("spd")||180;e.physics.velocityFromRotation(We,Qe,n.body.velocity),n.rotation=We+Math.PI/2;var k=Phaser.Math.Distance.Between(n.x,n.y,e.player.x,e.player.y);k<22&&(r.hp-=.2*(g/16.666))}}for(var Ae=e.mines.getChildren(),Re=0;Re<Ae.length;Re++){var F=Ae[Re];if(F.active&&(!F.getData("armed")&&a>=(F.getData("armAt")||0)&&(F.setData("armed",!0),F.setAlpha(.95)),F.getData("armed")))for(var Ce=F.getData("radius")||120,Ve=Ce*Ce,f=0;f<W.length;f++){var Be=W[f];if(Be.active){var oe=Be.x-F.x,ie=Be.y-F.y;if(oe*oe+ie*ie<=Ve){for(var ze=F.getData("dmg")||18,Ie=0;Ie<W.length;Ie++){var te=W[Ie];if(te.active){var Ue=te.x-F.x,qe=te.y-F.y;Ue*Ue+qe*qe<=Ve&&(te.setData("hp",(te.getData("hp")||20)-ze),te.getData("hp")<=0&&(te.destroy(),r.score+=1))}}var Ee=e.add.circle(F.x,F.y,Ce,65484,.18);Ee.setBlendMode(Phaser.BlendModes.ADD),e.time.delayedCall(180,function(){Ee.active&&Ee.destroy()}),F.destroy();break}}}}if(m&&m.active){var Le=r.cfg.ai,$e=Le.prefer,ea=Phaser.Math.Distance.Between(e.player.x,e.player.y,m.x,m.y),we=360;$e==="near"&&(we=220),$e==="mid"&&(we=380),$e==="far"&&(we=520);var aa=r.hp/r.hpMax<Le.fleeHp,Oe=Phaser.Math.Angle.Between(e.player.x,e.player.y,m.x,m.y),ge=1;aa||ea<we*Le.keep?ge=-1:ge=1,e.physics.velocityFromRotation(Oe,r.speed*.85*ge,e.player.body.velocity),e.player.rotation=ge===1?Oe+Math.PI/2:Oe-Math.PI/2}var ce=r.cfg.wpnA,de=r.cfg.wpnB;a-r.lastA>=ce.cd*1e3&&(r.lastA=a,H(e,ce,a,"ba")),a-r.lastB>=de.cd*1e3&&(r.lastB=a,H(e,de,a,"bb")),e.rangeG.clear();for(var ta=Math.max(ce.range||0,de.range||0,0),Ke=200,Ye=Math.max(1,Math.floor(ta/Ke));e.rangeTexts.length<Ye;){var je=e.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3});je.setDepth(9),e.rangeTexts.push(je)}for(var Fe=0;Fe<e.rangeTexts.length;Fe++)e.rangeTexts[Fe].setVisible(!1);for(var De=1;De<=Ye;De++){var Se=De*Ke;e.rangeG.lineStyle(1,16777215,.08),e.rangeG.strokeCircle(e.player.x,e.player.y,Se);var d=-Math.PI/4,ra=e.player.x+Math.cos(d)*Se,na=e.player.y+Math.sin(d)*Se,He=e.rangeTexts[De-1];He.setText(String(Se)),He.setPosition(ra+6,na-10),He.setVisible(!0)}if(ce.range&&ce.range>0&&(e.rangeG.lineStyle(2,65484,.2),e.rangeG.strokeCircle(e.player.x,e.player.y,ce.range)),de.range&&de.range>0&&(e.rangeG.lineStyle(2,16732120,.18),e.rangeG.strokeCircle(e.player.x,e.player.y,de.range)),e.radarG){e.radarG.clear();var he=e.radarX,pe=e.radarY,fe=e.radarR;e.radarG.fillStyle(0,.35),e.radarG.fillCircle(he,pe,fe+8),e.radarG.lineStyle(2,65484,.22),e.radarG.strokeCircle(he,pe,fe),e.radarG.lineStyle(1,16777215,.08),e.radarG.strokeCircle(he,pe,fe*.66),e.radarG.strokeCircle(he,pe,fe*.33),e.radarG.fillStyle(65484,.9),e.radarG.fillCircle(he,pe,3);for(var _e=e.radarRange,Ne=0;Ne<W.length;Ne++){var n=W[Ne];if(n.active){var oe=n.x-e.player.x,ie=n.y-e.player.y,l=Math.sqrt(oe*oe+ie*ie);if(!(l>_e)){var la=he+oe/_e*fe,sa=pe+ie/_e*fe,se=!!n.getData("blocked");e.radarG.fillStyle(se?16732120:16722731,se?.7:.85),e.radarG.fillCircle(la,sa,se?2:2.5)}}}}e.scorePanelG=e.add.graphics().setScrollFactor(0).setDepth(11),e.scoreText=e.add.text(0,0,"SCORE 0",{fontFamily:"system-ui, sans-serif",fontSize:"20px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:4}).setScrollFactor(0).setDepth(12),e.waveTimeText=e.add.text(0,0,"WAVE 1  TIME 00:00",{fontFamily:"system-ui, sans-serif",fontSize:"15px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.hpText=e.add.text(0,0,"HP 0/0",{fontFamily:"system-ui, sans-serif",fontSize:"16px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.expText=e.add.text(0,0,"EXP 0",{fontFamily:"system-ui, sans-serif",fontSize:"15px",fontStyle:"700",fill:"#ffd36b",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.weaponMainText=e.add.text(0,0,"MAIN",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.weaponSubText=e.add.text(0,0,"SUB",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3}).setScrollFactor(0).setDepth(12),e.weaponG=e.add.graphics().setScrollFactor(0).setDepth(12),ee(e,r,A),r.hp<=0&&(r.dead=!0,r.hp=0,ue(r.score,Math.floor(A||0),r.cfg))}catch(re){E("EXCEPTION: "+(re&&re.message?re.message:re)+(re&&re.stack?`
`+re.stack:"")),r.dead=!0}}S=new Phaser.Game(p)}function ue(t,o,s){try{S&&S.scene.pause()}catch{}P.showResult(t,o,s)}return E("bootGame called"),Pe(v),{destroy:()=>{try{S&&(S.destroy(!0),S=null)}catch{}}}},G=v=>{const P=document.getElementById(v);if(!P)throw new Error(`Missing required element: ${v}`);return P},da=v=>{let S=Math.max(0,v|0);const E=Math.floor(S/36e5);S-=E*36e5;const K=Math.floor(S/6e4);S-=K*6e4;const Y=Math.floor(S/1e3),j=S-Y*1e3;return`${String(E).padStart(2,"0")}:${String(K).padStart(2,"0")}:${String(Y).padStart(2,"0")}.${String(j).padStart(3,"0")}`},ha=v=>v.replace(/[&<>"]/g,P=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[P]??P),pa=v=>{const P=G("debugBtn"),S=G("debugPanel"),E=G("mechLogPanel"),K=G("mechLogLines"),Y=G("startPanel"),j=G("resultPanel"),ne=G("toast"),ee=G("selFrame"),X=G("selWpnA"),ae=G("selWpnB"),Q=G("selAI"),me=G("frameDesc"),ye=G("wpnADesc"),Ge=G("wpnBDesc"),Pe=G("aiDesc"),ue=G("kpi"),t=G("resultText"),o=G("resultKpi"),s=G("btnStart"),p=G("btnRetry");let r=!1;const x=[],M=[],C=window.location.hostname==="localhost"||window.location.search.includes("debug=1");document.body.classList.toggle("is-debug",C),P.style.display=C?"block":"none";const H=l=>{const i=new Date().toISOString().slice(11,19);x.push(`[${i}] ${l}`),x.length>200&&x.shift(),S.textContent=x.join(`
`)},B=l=>{ne.textContent=String(l)},a=(l,i,c)=>{E.style.display="block";const n=`c-${l??"sys"}`;M.push({t:i|0,cls:n,msg:c}),M.length>10&&M.shift();const f=5,h=M.map((I,w)=>{const L=w===M.length-1?"is-latest":"is-old";return`<div class='line ${I.cls} ${L}'>${da(I.t)} ${ha(I.msg)}</div>`});for(;h.length<f;)h.push("<div class='line placeholder'>&nbsp;</div>");K.innerHTML=h.join("")},g=(l,i)=>{l.innerHTML="",i.forEach(c=>{const n=document.createElement("option");n.value=c.id,n.textContent=c.name??c.id,l.appendChild(n)})},e=()=>{const l=v.frames.find(h=>h.id===ee.value),i=v.weapons.find(h=>h.id===X.value),c=v.weapons.find(h=>h.id===ae.value),n=v.ai.find(h=>h.id===Q.value);if(!l||!i||!c||!n)return;me.textContent=`${l.desc}  (HP ${l.hp} / SPD ${l.speed})`,ye.textContent=`${i.desc}  (R ${i.range} / DPS ${i.dps})`,Ge.textContent=`${c.desc}  (R ${c.range} / DPS ${c.dps})`,Pe.textContent=n.desc,ue.innerHTML="";const f=(h,I)=>{const w=document.createElement("div");w.className=`pill ${I??""}`.trim(),w.textContent=h,ue.appendChild(w)};f(`FRAME: ${l.name}`,"good"),f(`MAIN: ${i.name}`),f(`SUB: ${c.name}`),f(`AI: ${n.name}`)};return g(ee,v.frames),g(X,v.weapons),g(ae,v.weapons),g(Q,v.ai),ee.value="middle",X.value="mg",ae.value="cannon",Q.value="balanced",ee.addEventListener("change",e),X.addEventListener("change",e),ae.addEventListener("change",e),Q.addEventListener("change",e),e(),C&&P.addEventListener("click",()=>{r=!r,S.style.display=r?"block":"none"}),window.addEventListener("error",l=>{var c;const i=l!=null&&l.message?l.message:String(l);H(`ERROR: ${i}${(c=l==null?void 0:l.error)!=null&&c.stack?`
${l.error.stack}`:""}`),B(`ERROR: ${i}`)}),{onStart:l=>s.addEventListener("click",l),onRetry:l=>p.addEventListener("click",l),hideStart:()=>Y.classList.add("hidden"),showStart:()=>Y.classList.remove("hidden"),hideResult:()=>j.classList.add("hidden"),showResultPanel:()=>j.classList.remove("hidden"),getConfig:()=>({frameId:ee.value,wpnAId:X.value,wpnBId:ae.value,aiId:Q.value}),setToast:B,setDebug:H,pushMechLog:a,renderResult:(l,i,c)=>{const n=`SCORE: ${l}
TIME: ${i}s
FRAME: ${c.frame.name} / AI: ${c.ai.name}
MAIN: ${c.wpnA.name} / SUB: ${c.wpnB.name}`;t.textContent=n,o.innerHTML="";const f=(h,I)=>{const w=document.createElement("div");w.className=`pill ${I??""}`.trim(),w.textContent=h,o.appendChild(w)};f(`SCORE ${l}`,"good"),f(`TIME ${i}s`),f(c.frame.name),f(c.ai.name),f(`MAIN ${c.wpnA.name}`),f(`SUB ${c.wpnB.name}`,"bad")}}},V=pa(Te),fa=v=>{const P=oa[v.frameId],S=Xe[v.wpnAId],E=Xe[v.wpnBId],K=ia[v.aiId];if(!P||!S||!E||!K)throw new Error("Invalid loadout selection.");return{frame:P,wpnA:S,wpnB:E,ai:K}};let z=null;const ya={toast:V.setToast,debug:V.setDebug,mechLog:V.pushMechLog,showResult:(v,P,S)=>{V.renderResult(v,P,S),V.showResultPanel()}};V.onStart(()=>{V.hideResult(),V.hideStart();const v=fa(V.getConfig());z==null||z.destroy(),z=ca(v,ya)});V.onRetry(()=>{V.hideResult(),V.showStart(),z==null||z.destroy(),z=null,V.setToast("READY")});
