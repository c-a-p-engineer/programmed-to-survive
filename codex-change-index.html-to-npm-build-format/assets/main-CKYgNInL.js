import"./modulepreload-polyfill-B5Qt9EMX.js";const Ge={frames:[{id:"light",name:"LIGHT",hp:70,speed:240,en:100,enRegen:18,desc:"高速。薄い。回避で生きる。"},{id:"middle",name:"MIDDLE",hp:95,speed:210,en:120,enRegen:14,desc:"標準。バランス。"},{id:"heavy",name:"HEAVY",hp:130,speed:175,en:140,enRegen:11,desc:"鈍い。硬い。詰みづらい。"}],weapons:[{id:"mg",name:"Machinegun",type:"bullet",range:900,dps:14,cd:.1,speed:1e3,desc:"連射。見てて気持ちいい。",pierce:!1,explodeOnObstacle:!1},{id:"cannon",name:"Cannon",type:"bullet",range:1250,dps:22,cd:.55,speed:1250,desc:"高威力。遠距離。",pierce:!1,explodeOnObstacle:!1},{id:"missile",name:"Missile",type:"missile",range:1050,dps:18,cd:.7,speed:800,radius:110,desc:"範囲。雑に強い。",pierce:!1,explodeOnObstacle:!0},{id:"grenade",name:"Grenade",type:"lob",range:520,dps:16,cd:.85,speed:620,radius:85,desc:"近〜中。範囲。",pierce:!1,explodeOnObstacle:!0},{id:"blade",name:"Blade",type:"melee",range:120,dps:22,cd:.45,speed:0,desc:"近接。扇型。"},{id:"mine",name:"Mine",type:"mine",range:0,dps:22,cd:1.1,speed:0,radius:120,armMs:240,desc:"設置。踏ませる。"}],ai:[{id:"balanced",name:"Balanced",keep:.75,fleeHp:.18,prefer:"mid",desc:"無難。死ににくい。"},{id:"sniper",name:"Sniper",keep:.95,fleeHp:.12,prefer:"far",desc:"距離を取る。"},{id:"berserker",name:"Berserker",keep:.35,fleeHp:.08,prefer:"near",desc:"突っ込む。死にやすい。"},{id:"coward",name:"Coward",keep:.98,fleeHp:.35,prefer:"far",desc:"逃げる。稼げない。"},{id:"hunter",name:"Hunter",keep:.65,fleeHp:.1,prefer:"mid",desc:"近い敵を確実に。"}]},ta=Object.fromEntries(Ge.weapons.map(h=>[h.id,h])),Sa=Object.fromEntries(Ge.frames.map(h=>[h.id,h])),Ta=Object.fromEntries(Ge.ai.map(h=>[h.id,h])),wa=(h,w)=>{let D=null;const R=w.debug,W=w.toast,_=w.mechLog;function V(s,o,l){return s<o?o:s>l?l:s}function ae(s,o,l,d){var t=d===1?10:d===2?18:6,m=d===2?16732120:16777215,S=s.add.circle(o,l,t,m,d===2?.18:.22);S.setBlendMode(Phaser.BlendModes.ADD),S.setDepth(5),s.tweens.add({targets:S,alpha:0,duration:160,onComplete:function(){S.active&&S.destroy()}})}function J(s,o,l){var d=s.cameras.main,t=d.width,m=d.height;s.topPanelG&&(s.topPanelG.clear(),s.topPanelG.fillStyle(0,.58),s.topPanelG.fillRoundedRect(10,10,t-20,108,16),s.topPanelG.lineStyle(2,65484,.18),s.topPanelG.strokeRoundedRect(10,10,t-20,108,16));var S=Math.floor((l||0)*1e3),B=Math.floor(l||0),L=String(Math.floor(B/60)).padStart(2,"0"),F=String(B%60).padStart(2,"0");if(s.scoreText&&(s.scoreText.setText("SCORE "+String(o.score|0)),s.scoreText.setPosition(t-s.scoreText.width-18,18)),s.waveTimeText&&(s.waveTimeText.setText("WAVE "+String(o.wave||1)+"   TIME "+L+":"+F),s.waveTimeText.setPosition(18,20)),s.lockText){var a=o.targetDist!=null?String(o.targetDist|0):"--";s.lockText.setText("LOCK "+a+"m"),s.lockText.setPosition(18,54)}if(s.weaponText){var p=o.cfg.wpnA?o.cfg.wpnA.name:"A",e=o.cfg.wpnB?o.cfg.wpnB.name:"B";s.weaponText.setText("MAIN "+p+"  R"+(o.cfg.wpnA.range||0)+"   |   SUB "+e+"  R"+(o.cfg.wpnB.range||0)),s.weaponText.setPosition(18,84)}if(s.bottomPanelG&&(s.bottomPanelG.clear(),s.bottomPanelG.fillStyle(0,.52),s.bottomPanelG.fillRoundedRect(10,m-74,t-20,64,16),s.bottomPanelG.lineStyle(1,65484,.14),s.bottomPanelG.strokeRoundedRect(10,m-74,t-20,64,16)),s.mechInfoText){var P=Math.max(0,o.hp|0),r=Math.max(1,o.maxHp|0),c=Math.max(0,o.en|0),i=Math.max(1,o.maxEn|0);s.mechInfoText.setText("HP "+P+"/"+r+"   EN "+c+"/"+i+"   SPD "+(o.moveSpd|0)+"   KILL "+(o.kills|0)),s.mechInfoText.setPosition(18,m-56)}o.battleTimeMs=S}function K(s,o,l,d,t){if(!s.obstacles)return!1;var m=new Phaser.Geom.Line(o,l,d,t),S=s.obstacles.getChildren(),B=d-o,L=t-l,F=Math.sqrt(B*B+L*L);if(F<1)return!1;for(var a=0;a<S.length;a++){var p=S[a];if(p.active){var e=p.body;if(e){var P=e.x+e.width*.5,r=e.y+e.height*.5,c=P-o,i=r-l,y=Math.sqrt(c*c+i*i);if(!(y<34)&&!(y>F-10)){var n=new Phaser.Geom.Rectangle(e.x,e.y,e.width,e.height);if(Phaser.Geom.Intersects.LineToRectangle(m,n))return!0}}}}return!1}function Z(s,o,l,d,t){if(!s.obstacles)return null;for(var m=new Phaser.Geom.Line(o,l,d,t),S=s.obstacles.getChildren(),B=null,L=1e9,F=0;F<S.length;F++){var a=S[F];if(!(!a.active||!a.body)){var p=a.body,e=new Phaser.Geom.Rectangle(p.x,p.y,p.width,p.height);if(Phaser.Geom.Intersects.LineToRectangle(m,e)){var P=p.x+p.width*.5,r=p.y+p.height*.5,c=Phaser.Math.Distance.Between(o,l,P,r);c<L&&(L=c,B=a)}}}return B}function U(s,o,l,d){var t=s.make.graphics({x:0,y:0,add:!1});t.clear(),t.fillStyle(d,1),t.fillTriangle(l/2,1,1,l-1,l-1,l-1),t.generateTexture(o,l,l),t.destroy()}function me(s,o,l,d){var t=s.make.graphics({x:0,y:0,add:!1});t.clear(),t.fillStyle(0,.35),t.fillCircle(l/2+1,l/2+1,l/2),t.fillStyle(d,1),t.fillCircle(l/2,l/2,l/2-1),t.generateTexture(o,l,l),t.destroy()}function pe(s,o,l,d,t){var m=s.make.graphics({x:0,y:0,add:!1});m.clear(),m.fillStyle(t,1),m.fillRoundedRect(0,0,l,d,10),m.lineStyle(2,16777215,.12),m.strokeRoundedRect(2,2,l-4,d-4,8),m.lineStyle(1,65484,.1),m.beginPath(),m.moveTo(8,d*.35),m.lineTo(l-8,d*.35),m.moveTo(8,d*.65),m.lineTo(l-8,d*.65),m.strokePath(),m.generateTexture(o,l,d),m.destroy()}function Re(s,o,l){var d=s.make.graphics({x:0,y:0,add:!1});d.clear(),d.fillStyle(724758,1),d.fillCircle(l/2,l/2,l/2),d.lineStyle(2,65484,.55),d.strokeCircle(l/2,l/2,l/2-2),d.fillStyle(65484,.18),d.fillCircle(l/2,l/2,l/2-4),d.generateTexture(o,l,l),d.destroy()}function be(s){if(D){try{D.destroy(!0)}catch{}D=null}var o=430,l=820,d={type:Phaser.AUTO,parent:"game",width:o,height:l,backgroundColor:"#05070b",physics:{default:"arcade",arcade:{debug:!1,gravity:{y:0}}},scene:{preload:m,create:S,update:F}};const t={cfg:s,hp:s.frame.hp,hpMax:s.frame.hp,en:s.frame.en,enMax:s.frame.en,enRegen:s.frame.enRegen,speed:s.frame.speed,score:0,t0:0,lastA:0,lastB:0,target:null,lastSwitch:0,targetDist:0,lastDelta:0,dead:!1};function m(){U(this,"p",30,65484),U(this,"e",26,16731469),me(this,"ba",10,65484),me(this,"bb",10,16732120),Re(this,"mn",22),pe(this,"obA",140,90,2765892),pe(this,"obB",220,130,2305082),pe(this,"obC",110,180,2568772)}function S(){R("scene.create");var a=this;a.rangeTexts||(a.rangeTexts=[]),a.lockG||(a.lockG=a.add.graphics().setDepth(4)),a.radarG||(a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900),t.t0=a.time.now,a.physics.world.setBounds(-4e3,-4e3,8e3,8e3),a.player=a.physics.add.image(0,0,"p"),a.player.setDepth(2),a.player.setCircle(10),a.enemies=a.physics.add.group(),a.spawnAcc=0,a.spawnInterval=.85;function p(){var f=Math.random()*Math.PI*2,u=520+Math.random()*520,A=a.player.x+Math.cos(f)*u,G=a.player.y+Math.sin(f)*u,b=a.enemies.create(A,G,"e");return b.setData("hp",18),b.setData("blocked",!1),b.setRotation(Phaser.Math.Angle.Between(A,G,a.player.x,a.player.y)+Math.PI/2),b.setCollideWorldBounds(!1),b.setDepth(1),b}for(var e=0;e<6;e++)p();R("spawn init enemies="+a.enemies.getChildren().length),a.obsSpawnAcc=0,a.obsSpawnInterval=2.2,a.bullets=a.physics.add.group(),a.mines=a.physics.add.group(),a.obstacles=a.physics.add.staticGroup();for(var P=["obA","obB","obC"],r=0;r<25;r++){var c=Math.random()*Math.PI*2,i=280+Math.random()*1400,y=a.player.x+Math.cos(c)*i,n=a.player.y+Math.sin(c)*i,g=P[Math.random()*P.length|0],M=a.obstacles.create(y,n,g),I=M.body&&M.body.width?M.body.width:M.displayWidth||60,E=M.body&&M.body.height?M.body.height:M.displayHeight||60,q=Math.max(30,Math.floor(I*E/10));M.setData("maxHp",q),M.setData("hp",q),M.setAlpha(.55),M.setAlpha(.85),M.setRotation((Math.random()*2-1)*.18),M.setDepth(0),M.refreshBody()}a.obAcc=0,a.hud=a.add.text(12,12,"",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000000",strokeThickness:3}).setScrollFactor(0).setDepth(10),a.topPanelG=a.add.graphics().setScrollFactor(0).setDepth(11),a.bottomPanelG=a.add.graphics().setScrollFactor(0).setDepth(11),a.mechInfoText=a.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"16px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:5}).setScrollFactor(0).setDepth(12),a.barG=a.add.graphics().setScrollFactor(0).setDepth(10),a.rangeG=a.add.graphics().setDepth(0),a.lockG=a.add.graphics().setDepth(4),a.rangeTexts=[],a.radarG=a.add.graphics().setScrollFactor(0).setDepth(10),a.radarX=320,a.radarY=120,a.radarR=58,a.radarRange=900,a.cameras.main.startFollow(a.player,!0,.12,.12);var j=Math.max(t.cfg.wpnA.range||0,t.cfg.wpnB.range||0,520),Y=V(680/j,.45,.9);a.cameras.main.setZoom(Y),a.physics.add.overlap(a.bullets,a.enemies,function(f,u){if(!(!f.active||!u.active)){ae(a,f.x,f.y,f.getData("pierce")?1:0);var A=f.getData("dmg")||6,G=u.getData("hp")||20;G-=A,u.setData("hp",G),f.destroy(),G<=0&&(u.destroy(),t.score+=1,t.kills=(t.kills||0)+1,_("kill",t.battleTimeMs||0,"KILL ("+(f.getData("weaponName")||"WEAPON")+")"))}}),a.physics.add.overlap(a.bullets,a.obstacles,function(f,u){if(!(!f.active||!u.active)){var A=f.getData("bornAt")||0;if(!(A&&a.time.now-A<60)){var G=f.getData("aoe")||0,b=f.getData("dmg")||10;if(G>0&&f.getData("explodeOnObstacle")){ae(a,f.x,f.y,2);var te=a.add.circle(f.x,f.y,G,16732120,.14);te.setBlendMode(Phaser.BlendModes.ADD),a.time.delayedCall(180,function(){te.active&&te.destroy()})}else ae(a,f.x,f.y,1);var H=u.getData("hp"),Q=u.getData("maxHp")||60;typeof H!="number"&&(H=Q),H-=b,u.setData("hp",H);var k=Math.max(0,H/Q);if(u.setAlpha(.25+k*.45),u.setTint){var N=k<.5?9082293:7306918;k<.25&&(N=9132634),u.setTint(N)}H<=0&&(ae(a,u.x,u.y,2),u.destroy(),_("obj",t.battleTimeMs||0,"OBJECT DESTROYED")),f.destroy()}}}),a.physics.add.collider(a.player,a.obstacles),a.physics.add.collider(a.enemies,a.obstacles),a.input.on("pointerdown",function(f){if(!t.dead){var u=Phaser.Math.Angle.Between(a.player.x,a.player.y,f.worldX,f.worldY);a.player.rotation=u+Math.PI/2,a.physics.velocityFromRotation(u,t.speed,a.player.body.velocity)}}),a.spawnAcc=0,a.dmgAcc=0,W("BATTLE STARTED"),R("Battle started")}function B(a){for(var p=a.enemies.getChildren(),e=0;e<2;e++){for(var P=null,r=1e18,c=0;c<p.length;c++){var i=p[c];if(i.active){var y=K(a,a.player.x,a.player.y,i.x,i.y);if(!(e===0&&y)){var n=i.x-a.player.x,g=i.y-a.player.y,M=n*n+g*g;M<r&&(r=M,P=i)}}}if(P)return P}return null}function L(a,p,e,P){if(!t.dead&&!(!t.target||!t.target.active)){var r=p,c=t.target,i=a.player.x,y=a.player.y,n=c.x,g=c.y,M=Phaser.Math.Distance.Between(i,y,n,g);if(!(r.range>0&&M>r.range)){if(r.type!=="melee"&&r.type!=="mine"){var I=K(a,i,y,n,g);if(I){var E=Z(a,i,y,n,g);if(E&&E.active)n=E.x,g=E.y,E.body&&(n=E.body.x+E.body.width*.5,g=E.body.y+E.body.height*.5),a._breakCoverAcc=(a._breakCoverAcc||0)+(t.lastDelta||0),a._breakCoverAcc>1200&&(a._breakCoverAcc=0,_("obj",t.battleTimeMs||0,"BREAK COVER → obstacle"));else return}}if(r.type==="melee"){var q=Math.PI*.65,j=Phaser.Math.Angle.Between(i,y,n,g);a.player.rotation=j+Math.PI/2,a.slashG||(a.slashG=a.add.graphics(),a.slashG.setDepth(2)),a.slashG.clear(),a.slashG.fillStyle(65484,.1),a.slashG.lineStyle(2,65484,.28),a.slashG.beginPath(),a.slashG.slice(i,y,r.range,j-q/2,j+q/2,!1),a.slashG.closePath(),a.slashG.fillPath(),a.slashG.strokePath(),a.time.delayedCall(90,function(){a.slashG&&a.slashG.clear()});for(var Y=a.enemies.getChildren(),f=Math.max(10,Math.floor(r.dps*r.cd)),u=0;u<Y.length;u++){var A=Y[u];if(A.active){var G=A.x-i,b=A.y-y,te=Math.sqrt(G*G+b*b);if(!(te>r.range)){var H=Math.atan2(b,G),Q=Phaser.Math.Angle.Wrap(H-j);Math.abs(Q)<=q/2&&(A.setData("hp",(A.getData("hp")||20)-f),A.getData("hp")<=0&&(A.destroy(),t.score+=1))}}}return}if(r.type==="mine"){var k=a.physics.add.image(i,y,"mn");k.setDepth(1),k.setCircle(10),k.body.setImmovable(!0),k.body.setVelocity(0,0),k.setAlpha(.55),k.setData("armed",!1),k.setData("armAt",e+(r.armMs||240)),k.setData("radius",r.radius||120),k.setData("dmg",Math.max(12,Math.floor(r.dps*.9))),a.mines.add(k);return}var N=Phaser.Math.Angle.Between(i,y,n,g);a.player.rotation=N+Math.PI/2;var fe=Math.cos(N)*26,ye=Math.sin(N)*26,x=a.physics.add.image(i+fe,y+ye,P);x.setDepth(3),x.setCircle(4),x.setData("dmg",Math.max(6,Math.floor(r.dps*r.cd))),x.setData("bornAt",e),x.setData("pierce",!!r.pierce),x.setData("explodeOnObstacle",!!r.explodeOnObstacle),a.bullets.add(x),a.physics.velocityFromRotation(N,r.speed||1e3,x.body.velocity);var xe=Math.floor((r.range||900)/(r.speed||1e3)*1e3)+1200;a.time.delayedCall(xe,function(){x.active&&x.destroy()}),(r.type==="lob"||r.type==="missile")&&(x.setData("aoe",r.radius||90),x.setData("explodeOnObstacle",!!r.explodeOnObstacle))}}}function F(a,p){var e=this,P=t.startMs!=null?(e.time.now-t.startMs)/1e3:0;t.lastDelta=p;try{if(e._dbgAcc=(e._dbgAcc||0)+p,e._dbgAcc>700&&(e._dbgAcc=0,R("tick "+Math.floor(a))),t.dead)return;if(t.en=V(t.en+t.enRegen*(p/1e3),0,t.enMax),e.spawnAcc+=p/1e3,e.spawnAcc>=e.spawnInterval&&(e.spawnAcc=0,e.enemies.getChildren().length<26)){var r=Math.random()*Math.PI*2,c=560+Math.random()*660,i=e.player.x+Math.cos(r)*c,y=e.player.y+Math.sin(r)*c,n=e.enemies.create(i,y,"e");n.setData("hp",18),n.setData("blocked",!1),n.setRotation(Phaser.Math.Angle.Between(i,y,e.player.x,e.player.y)+Math.PI/2),n.setDepth(1)}e._cntAcc=(e._cntAcc||0)+p,e._cntAcc>2500&&(e._cntAcc=0,R("counts enemies="+e.enemies.getChildren().length+" obstacles="+(e.obstacles?e.obstacles.getChildren().length:0)+" bullets="+e.bullets.getChildren().length));for(var $=e.enemies&&e.enemies.getChildren?e.enemies.getChildren():[],g=0;g<$.length;g++){var n=$[g];if(!(!n.active||!n.body)){var M=Phaser.Math.Angle.Between(n.x,n.y,e.player.x,e.player.y),I=n.body.velocity.x,E=n.body.velocity.y,q=I*I+E*E,j=n.body.blocked&&(n.body.blocked.left||n.body.blocked.right||n.body.blocked.up||n.body.blocked.down)||n.body.touching&&(n.body.touching.left||n.body.touching.right||n.body.touching.up||n.body.touching.down)||q<40,Y=n.getData("turnBias")||0,f=n.getData("turnBiasT")||0;(j||f<=0)&&(Y=(Math.random()<.5?-1:1)*(.35+Math.random()*.35),f=220+Math.random()*260),f-=p,n.setData("turnBias",Y),n.setData("turnBiasT",f);var u=M+(f>0?Y:0),A=74,G=Phaser.Math.Distance.Between(n.x,n.y,e.player.x,e.player.y),b=A+(G<260?26:0);n.body.setVelocity(Math.cos(u)*b,Math.sin(u)*b),n.rotation=u+Math.PI/2}}var Ie=e.mines&&e.mines.getChildren?e.mines.getChildren():[],te=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(e.obsSpawnAcc+=p/1e3,e.obsSpawnAcc>=e.obsSpawnInterval){e.obsSpawnAcc=0;var H=e.obstacles&&e.obstacles.getChildren?e.obstacles.getChildren():[];if(H.length<70){for(var Q=0,k=0;k<H.length;k++){var N=H[k];N.active&&Phaser.Math.Distance.Between(N.x,N.y,e.player.x,e.player.y)<520&&Q++}if(Q<12){var r=Math.random()*Math.PI*2,c=360+Math.random()*560,i=e.player.x+Math.cos(r)*c,y=e.player.y+Math.sin(r)*c,fe=70+Math.random()*160,ye=50+Math.random()*150,x=e.obstacles.create(i,y,"ob");x.setImmovable(!0),x.body&&typeof x.body.setAllowGravity=="function"&&x.body.setAllowGravity(!1),x.body&&typeof x.body.setSize=="function"&&x.body.setSize(fe,ye,!0),x.displayWidth=fe,x.displayHeight=ye;var xe=Math.max(30,Math.floor(fe*ye/10));x.setData("maxHp",xe),x.setData("hp",xe),x.setAlpha(.55),typeof x.refreshBody=="function"&&x.refreshBody()}}}var v=t.target;if(v&&!v.active&&(v=null),!v)v=B(e),v&&(t.target=v,t.lastSwitch=a);else if(a-t.lastSwitch>=1e3){var re=B(e);if(re&&re!==v){var ra=Phaser.Math.Distance.Between(e.player.x,e.player.y,v.x,v.y),na=Phaser.Math.Distance.Between(e.player.x,e.player.y,re.x,re.y);na+40<ra&&(v=re,t.target=re,t.lastSwitch=a)}}t.targetDist=v&&v.active?Math.floor(Phaser.Math.Distance.Between(e.player.x,e.player.y,v.x,v.y)):0;for(var Ce=0;Ce<$.length;Ce++){var ve=$[Ce];if(ve.active){var ne=K(e,e.player.x,e.player.y,ve.x,ve.y);ve.setAlpha(ne?.18:1),ve.setData("blocked",ne)}}if(e.lockG.clear(),v&&v.active){e.lockG.lineStyle(2,16722731,.55),e.lockG.beginPath(),e.lockG.moveTo(e.player.x,e.player.y),e.lockG.lineTo(v.x,v.y),e.lockG.strokePath(),e.lockG.fillStyle(16722731,.9);var Me=7;e.lockG.beginPath(),e.lockG.moveTo(v.x,v.y-Me),e.lockG.lineTo(v.x+Me,v.y),e.lockG.lineTo(v.x,v.y+Me),e.lockG.lineTo(v.x-Me,v.y),e.lockG.closePath(),e.lockG.fillPath()}for(var $=e.enemies.getChildren(),Be=0;Be<$.length;Be++){var n=$[Be];if(n.active){var qe=Phaser.Math.Angle.Between(n.x,n.y,e.player.x,e.player.y),sa=n.getData("spd")||180;e.physics.velocityFromRotation(qe,sa,n.body.velocity),n.rotation=qe+Math.PI/2;var G=Phaser.Math.Distance.Between(n.x,n.y,e.player.x,e.player.y);G<22&&(t.hp-=.2*(p/16.666))}}for(var Ie=e.mines.getChildren(),Ee=0;Ee<Ie.length;Ee++){var C=Ie[Ee];if(C.active&&(!C.getData("armed")&&a>=(C.getData("armAt")||0)&&(C.setData("armed",!0),C.setAlpha(.95)),C.getData("armed")))for(var Le=C.getData("radius")||120,je=Le*Le,g=0;g<$.length;g++){var $e=$[g];if($e.active){var se=$e.x-C.x,le=$e.y-C.y;if(se*se+le*le<=je){for(var la=C.getData("dmg")||18,Oe=0;Oe<$.length;Oe++){var z=$[Oe];if(z.active){var Ye=z.x-C.x,Xe=z.y-C.y;Ye*Ye+Xe*Xe<=je&&(z.setData("hp",(z.getData("hp")||20)-la),z.getData("hp")<=0&&(z.destroy(),t.score+=1))}}var Fe=e.add.circle(C.x,C.y,Le,65484,.18);Fe.setBlendMode(Phaser.BlendModes.ADD),e.time.delayedCall(180,function(){Fe.active&&Fe.destroy()}),C.destroy();break}}}}if(v&&v.active){var He=t.cfg.ai,Ne=He.prefer,ia=Phaser.Math.Distance.Between(e.player.x,e.player.y,v.x,v.y),De=360;Ne==="near"&&(De=220),Ne==="mid"&&(De=380),Ne==="far"&&(De=520);var oa=t.hp/t.hpMax<He.fleeHp,We=Phaser.Math.Angle.Between(e.player.x,e.player.y,v.x,v.y),ge=1;oa||ia<De*He.keep?ge=-1:ge=1,e.physics.velocityFromRotation(We,t.speed*.85*ge,e.player.body.velocity),e.player.rotation=ge===1?We+Math.PI/2:We-Math.PI/2}var ie=t.cfg.wpnA,oe=t.cfg.wpnB;a-t.lastA>=ie.cd*1e3&&(t.lastA=a,L(e,ie,a,"ba")),a-t.lastB>=oe.cd*1e3&&(t.lastB=a,L(e,oe,a,"bb")),e.rangeG.clear();for(var ca=Math.max(ie.range||0,oe.range||0,0),Je=200,Ze=Math.max(1,Math.floor(ca/Je));e.rangeTexts.length<Ze;){var Qe=e.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"13px",fill:"#e8eefc",stroke:"#000",strokeThickness:3});Qe.setDepth(9),e.rangeTexts.push(Qe)}for(var _e=0;_e<e.rangeTexts.length;_e++)e.rangeTexts[_e].setVisible(!1);for(var Se=1;Se<=Ze;Se++){var Te=Se*Je;e.rangeG.lineStyle(1,16777215,.08),e.rangeG.strokeCircle(e.player.x,e.player.y,Te);var r=-Math.PI/4,da=e.player.x+Math.cos(r)*Te,ha=e.player.y+Math.sin(r)*Te,Ve=e.rangeTexts[Se-1];Ve.setText(String(Te)),Ve.setPosition(da+6,ha-10),Ve.setVisible(!0)}if(ie.range&&ie.range>0&&(e.rangeG.lineStyle(2,65484,.2),e.rangeG.strokeCircle(e.player.x,e.player.y,ie.range)),oe.range&&oe.range>0&&(e.rangeG.lineStyle(2,16732120,.18),e.rangeG.strokeCircle(e.player.x,e.player.y,oe.range)),e.radarG){e.radarG.clear();var ce=e.radarX,de=e.radarY,he=e.radarR;e.radarG.fillStyle(0,.35),e.radarG.fillCircle(ce,de,he+8),e.radarG.lineStyle(2,65484,.22),e.radarG.strokeCircle(ce,de,he),e.radarG.lineStyle(1,16777215,.08),e.radarG.strokeCircle(ce,de,he*.66),e.radarG.strokeCircle(ce,de,he*.33),e.radarG.fillStyle(65484,.9),e.radarG.fillCircle(ce,de,3);for(var Ke=e.radarRange,Ue=0;Ue<$.length;Ue++){var n=$[Ue];if(n.active){var se=n.x-e.player.x,le=n.y-e.player.y,c=Math.sqrt(se*se+le*le);if(!(c>Ke)){var pa=ce+se/Ke*he,fa=de+le/Ke*he,ne=!!n.getData("blocked");e.radarG.fillStyle(ne?16732120:16722731,ne?.7:.85),e.radarG.fillCircle(pa,fa,ne?2:2.5)}}}}if(e.scoreText=e.add.text(0,0,"SCORE 0",{fontFamily:"system-ui, sans-serif",fontSize:"38px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:6}).setScrollFactor(0).setDepth(12),e.waveTimeText=e.add.text(0,0,"WAVE 1  TIME 00:00",{fontFamily:"system-ui, sans-serif",fontSize:"18px",fontStyle:"700",fill:"#e8eefc",stroke:"#000",strokeThickness:5}).setScrollFactor(0).setDepth(12),e.weaponText=e.add.text(0,0,"",{fontFamily:"system-ui, sans-serif",fontSize:"15px",fill:"#e8eefc",stroke:"#000",strokeThickness:4}).setScrollFactor(0).setDepth(12),e.lockText=e.add.text(0,0,"LOCK --",{fontFamily:"system-ui, sans-serif",fontSize:"15px",fill:"#ffb3b3",stroke:"#000",strokeThickness:4}).setScrollFactor(0).setDepth(12),J(e,t,P),e.topPanelG){e.topPanelG.clear();var ze=e.cameras.main.width;e.topPanelG.fillStyle(0,.55),e.topPanelG.fillRoundedRect(10,10,ze-20,104,16),e.topPanelG.lineStyle(2,65484,.18),e.topPanelG.strokeRoundedRect(10,10,ze-20,104,16)}var ya=e.cameras.main.width;e.scoreText&&(e.scoreText.setText("SCORE "+String(t.score)),e.scoreText.setPosition(ya-e.scoreText.width-18,18));var ea=Math.floor(P||0),va=String(Math.floor(ea/60)).padStart(2,"0"),ga=String(ea%60).padStart(2,"0");if(e.waveTimeText&&(e.waveTimeText.setText("WAVE "+String(t.wave||1)+"   TIME "+va+":"+ga),e.waveTimeText.setPosition(18,20)),e.lockText){var ma=t.targetDist?String(t.targetDist):"--";e.lockText.setText("LOCK "+ma+"m"),e.lockText.setPosition(18,54)}if(e.weaponText){var ua=t.cfg.wpnA?t.cfg.wpnA.name:"A",xa=t.cfg.wpnB?t.cfg.wpnB.name:"B";e.weaponText.setText("MAIN "+ua+"  R"+(t.cfg.wpnA.range||0)+"   |   SUB "+xa+"  R"+(t.cfg.wpnB.range||0)),e.weaponText.setPosition(18,84)}var aa=Math.floor((a-t.t0)/1e3);e.hud.setText(["SCORE "+t.score+"   TIME "+aa+"s","HP "+Math.floor(t.hp)+" / "+t.hpMax+"    EN "+Math.floor(t.en)+" / "+t.enMax,"TARGET "+(t.target&&t.target.active?"LOCK":"-")+"  DIST "+t.targetDist+"px","MAIN "+t.cfg.wpnA.name+" | SUB "+t.cfg.wpnB.name,"AI "+t.cfg.ai.name+" | FRAME "+t.cfg.frame.name].join(`
`)),e.barG.clear();var we=240,Pe=10,ke=12,Ae=88,Ma=V(t.hp/t.hpMax,0,1);e.barG.fillStyle(16777215,.1),e.barG.fillRoundedRect(ke,Ae,we,Pe,6),e.barG.fillStyle(65484,.55),e.barG.fillRoundedRect(ke,Ae,Math.max(4,we*Ma),Pe,6);var Da=V(t.en/t.enMax,0,1);e.barG.fillStyle(16777215,.08),e.barG.fillRoundedRect(ke,Ae+14,we,Pe,6),e.barG.fillStyle(6728447,.55),e.barG.fillRoundedRect(ke,Ae+14,Math.max(4,we*Da),Pe,6),t.hp<=0&&(t.dead=!0,t.hp=0,ue(t.score,aa,t.cfg))}catch(ee){R("EXCEPTION: "+(ee&&ee.message?ee.message:ee)+(ee&&ee.stack?`
`+ee.stack:"")),t.dead=!0}}D=new Phaser.Game(d)}function ue(s,o,l){try{D&&D.scene.pause()}catch{}w.showResult(s,o,l)}return R("bootGame called"),be(h),{destroy:()=>{try{D&&(D.destroy(!0),D=null)}catch{}}}},T=h=>{const w=document.getElementById(h);if(!w)throw new Error(`Missing required element: ${h}`);return w},Pa=h=>{let D=Math.max(0,h|0);const R=Math.floor(D/36e5);D-=R*36e5;const W=Math.floor(D/6e4);D-=W*6e4;const _=Math.floor(D/1e3),V=D-_*1e3;return`${String(R).padStart(2,"0")}:${String(W).padStart(2,"0")}:${String(_).padStart(2,"0")}.${String(V).padStart(3,"0")}`},ka=h=>h.replace(/[&<>"]/g,w=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[w]??w),Aa=h=>{const w=T("debugBtn"),D=T("debugPanel"),R=T("mechLogPanel"),W=T("mechLogLines"),_=T("startPanel"),V=T("resultPanel"),ae=T("toast"),J=T("selFrame"),K=T("selWpnA"),Z=T("selWpnB"),U=T("selAI"),me=T("frameDesc"),pe=T("wpnADesc"),Re=T("wpnBDesc"),be=T("aiDesc"),ue=T("kpi"),s=T("resultText"),o=T("resultKpi"),l=T("btnStart"),d=T("btnRetry");let t=!1;const m=[],S=[],B=r=>{const c=new Date().toISOString().slice(11,19);m.push(`[${c}] ${r}`),m.length>200&&m.shift(),D.textContent=m.join(`
`)},L=r=>{ae.textContent=String(r)},F=(r,c,i)=>{R.style.display="block";const y=`c-${r??"sys"}`;S.push({t:c|0,cls:y,msg:i}),S.length>10&&S.shift(),W.innerHTML=S.map(n=>`<div class='line ${n.cls}'>${Pa(n.t)} ${ka(n.msg)}</div>`).join("")},a=(r,c)=>{r.innerHTML="",c.forEach(i=>{const y=document.createElement("option");y.value=i.id,y.textContent=i.name??i.id,r.appendChild(y)})},p=()=>{const r=h.frames.find(g=>g.id===J.value),c=h.weapons.find(g=>g.id===K.value),i=h.weapons.find(g=>g.id===Z.value),y=h.ai.find(g=>g.id===U.value);if(!r||!c||!i||!y)return;me.textContent=`${r.desc}  (HP ${r.hp} / SPD ${r.speed})`,pe.textContent=`${c.desc}  (R ${c.range} / DPS ${c.dps})`,Re.textContent=`${i.desc}  (R ${i.range} / DPS ${i.dps})`,be.textContent=y.desc,ue.innerHTML="";const n=(g,M)=>{const I=document.createElement("div");I.className=`pill ${M??""}`.trim(),I.textContent=g,ue.appendChild(I)};n(`FRAME: ${r.name}`,"good"),n(`MAIN: ${c.name}`),n(`SUB: ${i.name}`),n(`AI: ${y.name}`)};return a(J,h.frames),a(K,h.weapons),a(Z,h.weapons),a(U,h.ai),J.value="middle",K.value="mg",Z.value="cannon",U.value="balanced",J.addEventListener("change",p),K.addEventListener("change",p),Z.addEventListener("change",p),U.addEventListener("change",p),p(),w.addEventListener("click",()=>{t=!t,D.style.display=t?"block":"none"}),window.addEventListener("error",r=>{var i;const c=r!=null&&r.message?r.message:String(r);B(`ERROR: ${c}${(i=r==null?void 0:r.error)!=null&&i.stack?`
${r.error.stack}`:""}`),L(`ERROR: ${c}`)}),{onStart:r=>l.addEventListener("click",r),onRetry:r=>d.addEventListener("click",r),hideStart:()=>_.classList.add("hidden"),showStart:()=>_.classList.remove("hidden"),hideResult:()=>V.classList.add("hidden"),showResultPanel:()=>V.classList.remove("hidden"),getConfig:()=>({frameId:J.value,wpnAId:K.value,wpnBId:Z.value,aiId:U.value}),setToast:L,setDebug:B,pushMechLog:F,renderResult:(r,c,i)=>{const y=`SCORE: ${r}
TIME: ${c}s
FRAME: ${i.frame.name} / AI: ${i.ai.name}
MAIN: ${i.wpnA.name} / SUB: ${i.wpnB.name}`;s.textContent=y,o.innerHTML="";const n=(g,M)=>{const I=document.createElement("div");I.className=`pill ${M??""}`.trim(),I.textContent=g,o.appendChild(I)};n(`SCORE ${r}`,"good"),n(`TIME ${c}s`),n(i.frame.name),n(i.ai.name),n(`MAIN ${i.wpnA.name}`),n(`SUB ${i.wpnB.name}`,"bad")}}},O=Aa(Ge),Ga=h=>{const w=Sa[h.frameId],D=ta[h.wpnAId],R=ta[h.wpnBId],W=Ta[h.aiId];if(!w||!D||!R||!W)throw new Error("Invalid loadout selection.");return{frame:w,wpnA:D,wpnB:R,ai:W}};let X=null;const Ra={toast:O.setToast,debug:O.setDebug,mechLog:O.pushMechLog,showResult:(h,w,D)=>{O.renderResult(h,w,D),O.showResultPanel()}};O.onStart(()=>{O.hideResult(),O.hideStart();const h=Ga(O.getConfig());X==null||X.destroy(),X=wa(h,Ra)});O.onRetry(()=>{O.hideResult(),O.showStart(),X==null||X.destroy(),X=null,O.setToast("READY")});
